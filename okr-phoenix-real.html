<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Project Dashboard - Real Working Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Global performance optimizations */
        html {
            scroll-behavior: smooth;
        }
        
        *,
        *::before,
        *::after {
            backface-visibility: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            /* Scroll performance optimizations */
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            /* Performance optimizations */
            will-change: scroll-position;
            backface-visibility: hidden;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 800;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #4a5568;
        }

        .logout-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .dashboard-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-outlet-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-outlet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .outlets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            /* Performance optimizations */
            contain: layout style paint;
            transform: translateZ(0); /* Force hardware acceleration */
        }

        .phoenix-outlet-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #ff6b6b;
            transition: all 0.3s;
            cursor: pointer;
            /* Performance optimizations */
            will-change: transform, box-shadow;
            backface-visibility: hidden;
            transform: translateZ(0); /* Force hardware acceleration */
        }

        .phoenix-outlet-card:hover {
            transform: translateY(-5px) translateZ(0);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .outlet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .outlet-info h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .outlet-code {
            font-size: 0.85rem;
            color: #718096;
        }

        .phoenix-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #718096;
        }

        .progress-section {
            margin-top: 15px;
        }

        .progress-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .progress-bars {
            display: grid;
            gap: 8px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .progress-label {
            font-size: 0.8rem;
            color: #718096;
            flex: 1;
        }

        .progress-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
            margin-right: 10px;
        }

        .progress-bar {
            flex: 2;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .empty-state-desc {
            font-size: 1rem;
            margin-bottom: 25px;
        }

        /* Detail View Styles */
        .detail-view {
            display: none;
        }

        .back-button {
            background: #4a5568;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: #2d3748;
            transform: translateY(-1px);
        }

        .detail-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .detail-subtitle {
            color: #718096;
            font-size: 1rem;
        }

        .data-entry-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .data-input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 6px;
        }

        .data-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .data-input:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .input-help {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 4px;
        }

        .save-all-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            font-size: 1rem;
        }

        .save-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .outlet-search {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .outlet-search:focus {
            outline: none;
            border-color: #48bb78;
        }

        .outlet-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .outlet-item {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s;
        }

        .outlet-item:hover {
            background: #f8f9fa;
        }

        .outlet-item.selected {
            background: #e6fffa;
            border-color: #48bb78;
        }

        .outlet-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .outlet-item-code {
            font-size: 0.85rem;
            color: #718096;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #48bb78;
        }

        .notification.error {
            background: #e53e3e;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .notification.error {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .notification.warning {
            background: linear-gradient(135deg, #d69e2e, #b7791f);
        }

        .okr-template-option {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .okr-template-option:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .okr-template-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .okr-template-desc {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .okr-template-category {
            font-size: 0.8rem;
            color: #48bb78;
            font-weight: 600;
        }

        .progress-indicator {
            transition: all 0.3s ease;
        }

        .progress-indicator .progress-value {
            transition: color 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .outlets-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="dashboard-header">
                <div class="header-top">
                    <h1 class="dashboard-title">
                        🔥 Phoenix Project Dashboard
                    </h1>
                    <div class="user-info">
                        <span id="user-name">Loading...</span>
                        <button class="logout-btn" onclick="logout()">🚪 Logout</button>
                        <button class="debug-btn" onclick="toggleDebugPanel()" style="background: #f56565; color: white; border: none; padding: 8px 12px; border-radius: 5px; margin-left: 10px; cursor: pointer; font-size: 0.8rem;">🐛 Debug</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-phoenix-outlets">0</div>
                        <div class="stat-label">Phoenix Outlets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-revenue">Rp 0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-progress">0%</div>
                        <div class="stat-label">Avg Progress</div>
                    </div>
                </div>
                
                <!-- Medal Showcase -->
                <div id="medal-showcase" style="margin-top: 20px;"></div>
                

            </div>

            <!-- Debug Panel (Hidden by default) -->
            <div id="debug-panel" class="debug-panel" style="display: none; background: #2d2d2d; color: #fff; padding: 20px; border-radius: 10px; margin-bottom: 25px; font-family: monospace;">
                <h3 style="color: #f56565; margin-bottom: 15px;">🐛 Cross-Device Debug Panel</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #68d391; margin-bottom: 10px;">User & Permissions</h4>
                        <div id="debug-user-info" style="font-size: 0.85rem; line-height: 1.5;"></div>
                    </div>
                    
                    <div>
                        <h4 style="color: #63b3ed; margin-bottom: 10px;">Phoenix Data</h4>
                        <div id="debug-phoenix-data" style="font-size: 0.85rem; line-height: 1.5;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #f6ad55; margin-bottom: 10px;">Storage Status</h4>
                    <div id="debug-storage-info" style="font-size: 0.85rem; line-height: 1.5;"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="refreshDebugInfo()" style="background: #4299e1; color: white; border: none; padding: 10px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">🔄 Refresh</button>
                    <button onclick="forceLoadAllOutlets()" style="background: #ed8936; color: white; border: none; padding: 10px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">🔓 Force Load All</button>
                    <button onclick="exportDebugInfo()" style="background: #38b2ac; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">📤 Export Debug</button>
                </div>
            </div>

            <div class="dashboard-content">
                <div class="section-header">
                    <h2 class="section-title">
                        🏪 Phoenix Project Outlets
                    </h2>
                    <button class="add-outlet-btn" onclick="openAddOutletModal()">
                        ➕ Add Outlet to Phoenix Program
                    </button>
                </div>
                
                <div id="outlets-grid" class="outlets-grid">
                    <!-- Outlet cards will be rendered here -->
                </div>
                
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">🏪</div>
                    <div class="empty-state-title">No Phoenix Outlets Yet</div>
                    <div class="empty-state-desc">Start by adding outlets to the Phoenix Program to track their OKR progress</div>
                    <button class="add-outlet-btn" onclick="openAddOutletModal()">
                        ➕ Add Your First Outlet
                    </button>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detail-view" class="detail-view">
            <button class="back-button" onclick="backToCardView()">
                ← Back to Phoenix Dashboard
            </button>
            
            <div class="detail-header">
                <div class="detail-title" id="detail-outlet-name">Outlet Name</div>
                <div class="detail-subtitle" id="detail-outlet-info">Code: • AM:</div>
                <div class="phoenix-badge" style="display: inline-block; margin-top: 10px;">Phoenix Project Participant</div>
            </div>

            <div class="data-entry-section">
                <div class="section-title">
                    📊 Baseline & Performance Data Entry
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- Baseline Column -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 3px solid #667eea;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <h4 style="color: #667eea; font-size: 0.9rem; font-weight: 700; margin-bottom: 4px;">📊 Baseline</h4>
                            <div style="color: #718096; font-size: 0.75rem;">Revenue & Trano</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 8px;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Revenue Baseline</label>
                            <input type="number" id="input-baseline-revenue" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Monthly revenue</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Trano Baseline</label>
                            <input type="number" id="input-baseline-trano" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Monthly transactions</div>
                        </div>
                    </div>

                    <!-- Term 1 Column -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 3px solid #48bb78;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <h4 style="color: #48bb78; font-size: 0.9rem; font-weight: 700; margin-bottom: 4px;">📈 Term 1</h4>
                            <div style="color: #718096; font-size: 0.75rem;">Day 1 - 10</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 8px;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Revenue</label>
                            <input type="number" id="input-term1-revenue" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Rupiah (Rp)</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Trano</label>
                            <input type="number" id="input-term1-trano" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Transactions</div>
                        </div>
                    </div>

                    <!-- Term 2 Column -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 3px solid #feca57;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <h4 style="color: #d69e2e; font-size: 0.9rem; font-weight: 700; margin-bottom: 4px;">📊 Term 2</h4>
                            <div style="color: #718096; font-size: 0.75rem;">Day 11 - 20</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 8px;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Revenue</label>
                            <input type="number" id="input-term2-revenue" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Rupiah (Rp)</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Trano</label>
                            <input type="number" id="input-term2-trano" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Transactions</div>
                        </div>
                    </div>

                    <!-- Term 3 Column -->
                    <div style="background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 3px solid #ff6b6b;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <h4 style="color: #e53e3e; font-size: 0.9rem; font-weight: 700; margin-bottom: 4px;">📈 Term 3</h4>
                            <div style="color: #718096; font-size: 0.75rem;">Day 21 - 30/31</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 8px;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Revenue</label>
                            <input type="number" id="input-term3-revenue" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Rupiah (Rp)</div>
                        </div>
                        <div class="data-input-group" style="margin-bottom: 0;">
                            <label class="input-label" style="color: #4a5568; font-weight: 600; font-size: 0.8rem;">Trano</label>
                            <input type="number" id="input-term3-trano" class="data-input" placeholder="0" style="font-size: 0.9rem; font-weight: 600; text-align: center; padding: 6px;">
                            <div class="input-help" style="font-size: 0.7rem;">Transactions</div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Tracking Section -->
                <div id="progress-tracking" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #48bb78;">
                    <h4 style="color: #2d3748; margin-bottom: 12px; font-size: 0.95rem;">📊 Progress vs Baseline</h4>
                    <div id="progress-indicators" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div id="term1-progress" class="progress-indicator" style="text-align: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">Term 1 vs 10-Day Baseline</div>
                            <div class="progress-value" style="font-size: 1.1rem; font-weight: 700; color: #48bb78;">-</div>
                        </div>
                        <div id="term2-progress" class="progress-indicator" style="text-align: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">Term 1+2 vs 20-Day Baseline</div>
                            <div class="progress-value" style="font-size: 1.1rem; font-weight: 700; color: #d69e2e;">-</div>
                        </div>
                        <div id="term3-progress" class="progress-indicator" style="text-align: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 0.8rem; color: #718096; margin-bottom: 4px;">Full Month vs Baseline</div>
                            <div class="progress-value" style="font-size: 1.1rem; font-weight: 700; color: #e53e3e;">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Sales Target Section -->
                <div id="monthly-target-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: white;">
                    <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        🎯 Monthly Sales Target & Rewards
                        <span id="detail-tier-medal" style="font-size: 1.5rem;">⚪</span>
                    </h4>
                    
                    <!-- Target Input -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <label style="display: block; font-size: 0.9rem; margin-bottom: 8px; color: rgba(255,255,255,0.9); font-weight: 600;">
                            Set Monthly Sales Target (100% - Tier 3 Gold):
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" 
                                   id="detail-monthly-target" 
                                   placeholder="Enter target amount" 
                                   style="flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; text-align: center;"
                                   onchange="updateDetailMonthlyTarget()"
                                   oninput="calculateDetailTierProgress()">
                            <button onclick="updateDetailMonthlyTarget()" 
                                    style="background: #48bb78; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                💾 Save Target
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tier Progress Display -->
                    <div id="detail-tier-display" style="display: none;">
                        <!-- Current Achievement -->
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span id="detail-tier-name" style="font-size: 1rem; font-weight: 700;">Not Qualified</span>
                                <span id="detail-achievement-percentage" style="font-size: 1rem; font-weight: 700;">0%</span>
                            </div>
                            <div style="position: relative; background: rgba(255,255,255,0.2); border-radius: 12px; height: 12px; margin-bottom: 25px; overflow: visible;">
                                <div id="detail-progress-bar" style="background: #48bb78; height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 12px;"></div>
                                
                                <!-- Lock Icons with Labels at 80%, 90%, 100% positions -->
                                <div style="position: absolute; left: 80%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div id="detail-tier1-lock" style="font-size: 1rem;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap; color: white;">Tier 1<br>Bronze</div>
                                </div>
                                <div style="position: absolute; left: 90%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div id="detail-tier2-lock" style="font-size: 1rem;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap; color: white;">Tier 2<br>Silver</div>
                                </div>
                                <div style="position: absolute; left: 100%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div id="detail-tier3-lock" style="font-size: 1rem;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap; color: white;">Tier 3<br>Gold</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tier Breakdown -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                            <div id="detail-tier1" style="background: rgba(205,127,50,0.3); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.2rem; margin-bottom: 6px;">🥉</div>
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px;">Tier 1 - Bronze</div>
                                <div id="detail-tier1-amount" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">Rp 0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">1.35% reward</div>
                            </div>
                            <div id="detail-tier2" style="background: rgba(192,192,192,0.3); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.2rem; margin-bottom: 6px;">🥈</div>
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px;">Tier 2 - Silver</div>
                                <div id="detail-tier2-amount" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">Rp 0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">2.0% reward</div>
                            </div>
                            <div id="detail-tier3" style="background: rgba(255,215,0,0.3); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.2rem; margin-bottom: 6px;">🥇</div>
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px;">Tier 3 - Gold</div>
                                <div id="detail-tier3-amount" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">Rp 0</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">2.7% reward</div>
                            </div>
                        </div>
                        
                        <!-- Reward Display -->
                        <div id="detail-reward-display" style="background: rgba(72,187,120,0.3); border: 1px solid rgba(72,187,120,0.5); border-radius: 10px; padding: 15px; text-align: center; display: none;">
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">🎉 Congratulations! Your Current Reward:</div>
                            <div id="detail-reward-amount" style="font-size: 1.3rem; font-weight: 700; color: #48bb78; margin-bottom: 4px;">Rp 0</div>
                            <div id="detail-reward-percentage" style="font-size: 0.8rem; opacity: 0.8;">(0% of revenue)</div>
                        </div>
                        
                        <!-- Motivation Display -->
                        <div id="detail-motivation-display" style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; text-align: center;">
                            <div id="detail-motivation-text" style="font-size: 0.85rem; opacity: 0.9;">Set your monthly target to see tier progress and rewards</div>
                        </div>
                    </div>
                </div>
                
                <button class="save-all-btn" onclick="saveOutletDetailData()">
                    💾 Save All Data
                </button>
            </div>

            <div class="data-entry-section">
                <div class="section-title">
                    🎯 OKR Management
                </div>
                
                <div id="outlet-okr-section">
                    <!-- OKR content will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Add Outlet Modal -->
        <div id="add-outlet-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">➕ Add Outlet to Phoenix Program</div>
                <input type="text" id="outlet-search" class="outlet-search" placeholder="Search outlets..." onkeyup="filterOutlets()">
                <div id="outlet-list" class="outlet-list">
                    <!-- Available outlets will be rendered here -->
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeAddOutletModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addSelectedOutlet()" id="add-outlet-confirm-btn" disabled>Add to Phoenix</button>
                </div>
            </div>
        </div>

        <!-- OKR Assignment Modal -->
        <div id="okr-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header" id="okr-modal-title">🎯 Assign OKR</div>
                <div id="okr-modal-body">
                    <!-- OKR content will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- Comment Modal -->
        <div id="comment-modal" class="modal">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
                <div class="modal-header" id="comment-modal-title">💬 Action Plan Comments</div>
                <div id="comment-modal-body">
                    <div id="comment-action-text" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; color: #4a5568;"></div>
                    
                    <!-- Chat Messages Container -->
                    <div id="chat-messages" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fafafa;">
                        <!-- Messages will be rendered here -->
                    </div>
                    
                    <!-- New Comment Input -->
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-comment-input" 
                               placeholder="Type your comment here..."
                               style="flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem;"
                               onkeypress="if(event.key==='Enter') addNewComment()">
                        <button onclick="addNewComment()" 
                                style="background: #48bb78; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Send
                        </button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeCommentModal()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- KR Edit Modal -->
        <div id="kr-edit-modal" class="modal">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
                <div class="modal-header" id="kr-edit-modal-title">✏️ Edit Key Result Actions</div>
                <div id="kr-edit-modal-body">
                    <div id="kr-edit-text" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; color: #4a5568; font-weight: 600;"></div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Action Plans:</label>
                        <div id="action-plans-editor" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; background: #fafafa;">
                            <!-- Editable action plans will be rendered here -->
                        </div>
                        <button onclick="addNewActionPlan()" 
                                style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 0.9rem;">
                            + Add New Action Plan
                        </button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeKREditModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveKREdit()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Reward Medal Modal -->
        <div id="reward-medal-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">🏆 Award Special Medal</div>
                <div id="reward-medal-modal-body">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Select Outlet:</label>
                        <select id="reward-outlet-select" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                            <option value="">Choose an outlet...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Medal Type:</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <button class="medal-type-btn" data-type="most_improved" onclick="selectMedalType('most_improved')" 
                                    style="padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.5rem;">📈</div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #4a5568;">Most Improved</div>
                            </button>
                            <button class="medal-type-btn" data-type="most_compliant" onclick="selectMedalType('most_compliant')" 
                                    style="padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.5rem;">✅</div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #4a5568;">Most Compliant</div>
                            </button>
                            <button class="medal-type-btn" data-type="early_achiever" onclick="selectMedalType('early_achiever')" 
                                    style="padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.5rem;">⚡</div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #4a5568;">Early Achiever</div>
                            </button>
                            <button class="medal-type-btn" data-type="excellence" onclick="selectMedalType('excellence')" 
                                    style="padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.5rem;">⭐</div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #4a5568;">Excellence</div>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Medal Tier:</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="medal-tier-btn" data-tier="3" onclick="selectMedalTier(3)" 
                                    style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.2rem;">🥇</div>
                                <div style="font-size: 0.8rem; font-weight: 600; color: #4a5568;">Gold</div>
                            </button>
                            <button class="medal-tier-btn" data-tier="2" onclick="selectMedalTier(2)" 
                                    style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.2rem;">🥈</div>
                                <div style="font-size: 0.8rem; font-weight: 600; color: #4a5568;">Silver</div>
                            </button>
                            <button class="medal-tier-btn" data-tier="1" onclick="selectMedalTier(1)" 
                                    style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 1.2rem;">🥉</div>
                                <div style="font-size: 0.8rem; font-weight: 600; color: #4a5568;">Bronze</div>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Reward Amount (Rp):</label>
                        <input type="number" id="reward-amount" placeholder="e.g., 500000" 
                               style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;" min="0" step="1000">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 10px;">Reason/Notes:</label>
                        <textarea id="reward-reason" placeholder="Reason for awarding this medal..." 
                                  style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeRewardMedalModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="awardSpecialMedal()">Award Medal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="config.js"></script>
    <script src="google-sheets-api.js"></script>
    <script src="github-api.js"></script>
    <script src="auth-service.js"></script>
    <script src="simple-cloud-storage-v2.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let userPermissions = null;
        let allOutlets = [];
        let phoenixOutlets = [];
        let selectedOutletForAdd = null;
        let currentOKROutlet = null;

        // Phoenix OKR Templates - EXACT from user's reference document
        const phoenixOKRTemplates = [
            {
                id: 1,
                title: '🔥 OKR PHOENIX PROJECT – PENINGKATAN TRANSAKSI (TRAFIK BARU & RETURN RATE)',
                description: 'Meningkatkan volume transaksi harian sebanyak 10%/mth melalui peningkatan trafik masuk (walk-in), pendaftaran member baru, dan kunjungan ulang pelanggan dengan strategi booth & flyering.',
                category: 'Phoenix Main',
                keyResults: [
                    'KR1 – Melakukan 15 Tes Kesehatan/Hari melalui Booth Campaign (Setiap Selasa, Kamis, Minggu)',
                    'KR2 – Capai >90% Tingkat Rekrutmen Member VIP dari Pelanggan Non-Member + Picu Kunjungan Ulang melalui Reminder & Voucher',
                    'KR3 – Sebar 1.000 Flyer AJH di Hotzone dengan Hook Membership + Voucher (Dalam 30 Hari)',
                    'KR4 – Gunakan Menit Konsult (MK) untuk Tingkatkan Kunjungan Unik Kasus Penyakit Ringan'
                ],
                actionPlans: {
                    kr1: [
                        'Pasang tripod banner bertuliskan "Diskon 50% Cek Kesehatan" dan putar lagu Apotek Alpro dengan speaker',
                        'Ajak pelanggan sekitar atau yang lewat untuk cek tekanan darah secara gratis (tanpa form registrasi)',
                        'Setelah tes, arahkan pelanggan masuk ke outlet untuk daftar sebagai member VIP gratis dan mendapatkan paket voucher senilai Rp40rb',
                        'Kirim hasil tes ke pelanggan melalui WhatsApp via sistem Octopus',
                        'Catat jumlah tester harian ke dalam Tracking GS'
                    ],
                    kr2: [
                        'Ajak semua pelanggan non-member untuk daftar sebagai member VIP (berlaku 3 bulan)',
                        'Jelaskan dengan jelas keuntungan member VIP — terutama 4x voucher Rp10rb',
                        'Ingatkan pelanggan agar kembali sebelum voucher kedaluwarsa',
                        'Kirim reminder bulanan via WA kepada member baru terkait voucher yang belum digunakan'
                    ],
                    kr3: [
                        'Jadwalkan pembagian flyer saat jam sibuk di hotzone (radius maksimal 500 meter)',
                        'Promosikan: "Gratis Tes + Member + Voucher Rp40rb – Datang & Klaim di Outlet!"',
                        'Ajak penerima flyer langsung datang dan klaim, tidak perlu potong/stempel',
                        'Catat sisa flyer harian dalam GS'
                    ],
                    kr4: [
                        'Siapkan paket MK terlebih dahulu & lakukan pelatihan kepada staf (oleh AM/BM)',
                        'Gunakan MK sebagai strategi upsell untuk keluhan ringan (misalnya masuk angin, pusing ringan, maag)',
                        'Catat jumlah MK yang keluar setiap hari di GS',
                        'Tim Strategi akan memantau tren kenaikan MK bulanan'
                    ]
                }
            },
            {
                id: 2,
                title: '🏢 OKR – APARTMENT OUTLET TRANSACTION BOOST',
                description: 'Untuk meningkatkan jumlah transaksi sebanyak 10%/mth di outlet Apotek Alpro berbasis apartemen melalui visibilitas yang lebih kuat, peningkatan kenyamanan, dan keterlibatan komunitas yang terstruktur.',
                category: 'Apartment Outlet',
                keyResults: [
                    'KR1 – Pasang minimal 2 titik materi promosi (banner/standee) di area lobby atau akses utama/jalur lift apartemen selama 2 bulan penuh (Agustus–September 2025)',
                    'KR2 – Distribusikan 1.000 kartu nama WA Order/brosur per bulan (Agustus–Oktober), diselipkan ke struk pembelian obat kronis',
                    'KR3 – Bangun engagement komunitas apartemen melalui WA Group, dengan target 100 member baru/bulan dan 10 posting edukatif/promo per bulan, selama 3 bulan',
                    'KR4 – Meningkatkan repeat order rate pelanggan kronis apartemen sebesar 20% dibanding baseline Juli 2025 dalam waktu 60 hari',
                    'KR5 – Distribusi 1.000 Flyer AJH di area apartemen (Agustus–September 2025), dengan izin untuk disisipkan ke mailbox atau jalur lift (jika memungkinkan)'
                ],
                actionPlans: {
                    kr1: [
                        'Survei titik strategis: lobby utama, pintu masuk tower, area lift',
                        'Foto&ajukan titik + minta quotation ke Strategy Team, cc BPT',
                        'Setelah disetujui, pasang materi promosi dan dokumentasikan',
                        'Materi tetap terpasang selama minimal 2 bulan penuh'
                    ],
                    kr2: [
                        'Cetak 1.000 kartu nama atau flyer mini setiap bulan (request ke BPT)',
                        'Setiap transaksi obat kronis wajib diselipkan 1 kartu nama di atas struk',
                        'Edukasi pelanggan: bisa pesan ulang via WA, barang dititipkan di lobby',
                        'Pantau jumlah kartu terpakai setiap minggu di GS'
                    ],
                    kr3: [
                        'Gabung ke grup WA tower (jika tersedia) atau buat grup WA baru khusus penghuni tower',
                        'Undang pelanggan untuk join saat transaksi atau di booth',
                        'Ambil konten dari IG BPT atau WA Channel Alpro untuk dishare',
                        'Lakukan minimal 10 posting edukasi/promo setiap bulan (setiap 3 hari)',
                        'Target pertumbuhan grup: +100 member baru per bulan x 3 bulan'
                    ],
                    kr4: [
                        'Export data pelanggan obat kronis dari penjualan bulan lalu',
                        'Filter pelanggan yang pembelian terakhirnya sudah >1 bulan',
                        'Kirim pesan WhatsApp follow-up untuk ingatkan jadwal konsumsi rutin',
                        'Tawarkan untuk datang ke outlet atau titip ke lobby + voucher kecil'
                    ],
                    kr5: [
                        'Ajukan izin ke pengelola apartemen untuk penyisipan flyer ke mailbox/unit',
                        'Jika tidak diizinkan, sebar manual di area ramai (lobby, minimarket, parkiran)',
                        'Gunakan flyer hook: "Gratis Cek + Member + Voucher Rp40rb"',
                        'Catat jumlah flyer terdistribusi harian di GS'
                    ]
                }
            },
            {
                id: 3,
                title: '💰 SMART OKR – BUYING POWER BOOST',
                description: 'To increase average Buying Power per customer by 10% per month through PWP, MK usage, internal product training, and targeted upselling.',
                category: 'Buying Power',
                keyResults: [
                    'KR1 – Capai 100% target PWP setiap bulan dengan pelatihan CE dan monitoring harian',
                    'KR2 – Capai penggunaan MK (Menit Konsult) sebanyak minimum 150x per bulan, dengan tracking harian',
                    'KR3 – BM melakukan training internal produk kepada CE minimal 1x/hari dengan topik 1 produk fokus dan skrip upsell terkait',
                    'KR4 – Tambahkan 3 SKU sebagai fokus top-up bulanan, dengan target penjualan minimum 50 pcs/SKU/bulan'
                ],
                actionPlans: {
                    kr1: [
                        'Lakukan pelatihan oleh BM kepada CE tentang cara mengkomunikasikan PWP secara persuasif',
                        'Gunakan skrip PWP: "Kak, produk ini lagi promo loh – bisa ditambah RpX saja, hematnya bisa sampai 30%"',
                        'Update progres PWP setiap malam di grup internal outlet (dengan jumlah transaksi & % dari target)',
                        'Tempelkan reminder produk PWP aktif di area kasir',
                        'Pastikan seluruh tim tahu produk PWP yang aktif mingguan'
                    ],
                    kr2: [
                        'Tetapkan target harian MK = 5 pasien/hari',
                        'Tracking MK langsung di Google Sheet harian (tanpa perlu form log)',
                        'MK dapat dilakukan untuk semua keluhan ringan maupun penguatan penjualan OTC',
                        'Pantau mingguan: apakah jumlah MK meningkat dan dampaknya terhadap transaksi dan BP'
                    ],
                    kr3: [
                        'BM memilih 1 produk per hari yang akan difokuskan (misalnya: Omega 3, Vit C, Sari Kunyit)',
                        'BM melakukan briefing ke CE setiap pagi sebelum shift (5–10 menit)',
                        'Sertakan skrip upsell dalam training, contoh: "Kalau beli obat darah tinggi, bisa ditambahkan Omega 3 sebagai pendamping"',
                        'Target: produk tersebut disampaikan minimal ke 5 customer per shift',
                        'Laporkan produk harian yang ditraining & hasilnya dalam tracking mingguan'
                    ],
                    kr4: [
                        'Outlet memilih 3 SKU add-on untuk bulan berjalan (rekomendasi dari Strategy/BPT)',
                        'Display produk di kasir dengan tag "Favorit Kami!" atau "Bisa Ditambahkan"',
                        'Tetapkan target: 50 pcs per SKU per bulan',
                        'Pantau penjualan SKU ini mingguan',
                        'Laporkan hasil ke Strategy Team untuk evaluasi dampaknya terhadap BP'
                    ]
                }
            }
        ];

        // Phoenix data structure - now stored in Google Sheets for cross-device access
        let phoenixData = { outlets: {} };
        
        // Enhanced debugging for Phoenix data loading
        console.log('🔍 Phoenix Dashboard - Loading cross-device data...');

        // Initialize dashboard
        window.addEventListener('load', async () => {
            try {
                // Check authentication
                const userAuth = sessionStorage.getItem('userAuth');
                if (!userAuth) {
                    sessionStorage.setItem('returnUrl', 'okr-phoenix-real.html');
                    window.location.href = 'okr-login.html';
                    return;
                }
                
                currentUser = JSON.parse(userAuth);
                console.log('✅ Phoenix Real Dashboard - User authenticated:', currentUser.username);
                
                // Initialize services (optional - don't fail if unavailable)
                try {
                    const googleSheetsAPI = new GoogleSheetsAPI();
                    const authService = new AuthService();
                    await authService.initialize();
                    
                    // Load all outlets from Google Sheets
                    await loadAllOutlets(googleSheetsAPI);
                    console.log('✅ External services initialized successfully');
                } catch (serviceError) {
                    console.warn('⚠️ External services unavailable, using fallback data:', serviceError.message);
                    // Use fallback outlet data if Google Sheets is unavailable
                    allOutlets = [
                        { id: 1, code: 'DEMO01', name: 'APOTEK ALPRO DEMO 1', am: 'DEMO AM' },
                        { id: 2, code: 'DEMO02', name: 'APOTEK ALPRO DEMO 2', am: 'DEMO AM' },
                        { id: 3, code: 'DEMO03', name: 'APOTEK ALPRO DEMO 3', am: 'DEMO AM' }
                    ];
                    
                    // Add some demo Phoenix data if none exists
                    if (Object.keys(phoenixData.outlets).length === 0) {
                        phoenixData.outlets['DEMO01'] = {
                            okr: {
                                objective: "Meningkatkan volume transaksi harian sebanyak 10%/mth melalui peningkatan trafik masuk (walk-in), pendaftaran member baru, dan kunjungan ulang pelanggan dengan strategi booth & flyering.",
                                description: "Focus on increasing daily transaction volume through targeted customer acquisition and retention strategies.",
                                keyResults: [
                                    "Melakukan 15 Tes Kesehatan/Hari melalui Booth Campaign (Setiap Selasa, Kamis, Minggu)",
                                    "Ajak pelanggan sekitar atau yang lewat untuk cek tekanan darah secara gratis (tanpa form registrasi)",
                                    "Setelah tes, arahkan pelanggan masuk ke outlet untuk daftar sebagai member VIP gratis"
                                ],
                                actionPlans: {
                                    kr1: [
                                        "Pasang tripod banner bertuliskan 'Diskon 50% Cek Kesehatan' dan putar lagu Apotek Alpro dengan speaker",
                                        "Ajak pelanggan sekitar atau yang lewat untuk cek tekanan darah secara gratis (tanpa form registrasi)",
                                        "Setelah tes, arahkan pelanggan masuk ke outlet untuk daftar sebagai member VIP gratis dan mendapatkan paket voucher senilai Rp40rb"
                                    ],
                                    kr2: [
                                        "Kirim hasil tes ke pelanggan melalui WhatsApp via sistem Octopus"
                                    ],
                                    kr3: [
                                        "Setup booth setiap hari di dalam Pavilion GS"
                                    ]
                                },
                                progress: 25
                            },
                            performanceData: {
                                term1: { revenue: 8500000, trano: 150 },
                                term2: { revenue: 9200000, trano: 165 },
                                term3: { revenue: 8800000, trano: 158 }
                            }
                        };
                    }
                }
                
                // Setup user permissions
                setupUserPermissions();
                
                // Load Phoenix data from cloud storage (cross-device access)
                console.log('🔄 Loading Phoenix data from cloud storage...');
                await loadPhoenixDataFromCloud();
                
                // Load Phoenix outlets from loaded data
                console.log('🔄 Starting Phoenix outlet loading sequence...');
                loadPhoenixOutlets();
                
                // Render dashboard with loaded data
                console.log('🎨 Rendering Phoenix dashboard...');
                renderPhoenixDashboard();
                
                // Double-check data persistence
                console.log('🔍 Final Phoenix data verification:');
                console.log('📊 Phoenix outlets loaded:', phoenixOutlets.length);
                console.log('💾 Phoenix data in localStorage:', Object.keys(phoenixData.outlets).length, 'outlets');
                
                console.log('✅ Phoenix Real Dashboard initialized successfully');
                
            } catch (error) {
                console.error('❌ Phoenix Real Dashboard initialization failed:', error);
                console.error('❌ Error details:', error.message, error.stack);
                
                // Don't auto-logout on initialization errors - allow user to stay logged in
                // Only logout if it's a critical authentication error
                if (error.message && error.message.includes('auth')) {
                    sessionStorage.removeItem('userAuth');
                    sessionStorage.setItem('returnUrl', 'okr-phoenix-real.html');
                    window.location.href = 'okr-login.html';
                } else {
                    // Show error but keep user logged in
                    showNotification('⚠️ Some features may not work properly due to initialization errors', 'warning');
                    console.warn('⚠️ Continuing with limited functionality...');
                    
                    // Try to render basic dashboard without external services
                    try {
                        setupUserPermissions();
                        loadPhoenixOutlets();
                        renderPhoenixDashboard();
                        renderMedalShowcase();
                    } catch (fallbackError) {
                        console.error('❌ Fallback rendering also failed:', fallbackError);
                        showNotification('❌ Dashboard failed to load. Please refresh the page.', 'error');
                    }
                }
            }
        });

        async function loadAllOutlets(googleSheetsAPI) {
            try {
                const credentials = await googleSheetsAPI.loadOutletCredentials();
                allOutlets = Object.keys(credentials).map((outletCode, index) => ({
                    id: index + 1,
                    code: outletCode,
                    name: credentials[outletCode].outletName || `APOTEK ALPRO ${outletCode}`,
                    am: credentials[outletCode].am || 'SYSTEM AM'
                }));
                console.log(`✅ Loaded ${allOutlets.length} outlets from Google Sheets`);
            } catch (error) {
                console.error('❌ Failed to load outlets:', error);
                allOutlets = [];
            }
        }

        function setupUserPermissions() {
            console.log('🔐 Setting up user permissions for:', currentUser);
            
            if (currentUser.type === 'outlet') {
                // OUTLET USERS: Only see their own outlet's OKR card
                userPermissions = {
                    canViewAllOutlets: false,
                    canAddOutlets: false,
                    allowedOutlets: [currentUser.username.toUpperCase()],
                    canAssignOKR: false,
                    canEditOKR: true, // Outlets can edit their own OKR
                    canDeleteOKR: false,
                    canRewardMedals: false,
                    canComment: true, // Outlets can comment on their own OKR
                    canLike: true, // Outlets can like actions on their own OKR
                    role: 'Outlet'
                };
                console.log('🏪 Outlet permissions set - can only access:', userPermissions.allowedOutlets);
                
            } else if (currentUser.type === 'hq') {
                // HQ USERS: Based on role from Google Sheets
                const isAdmin = currentUser.role === 'ADMIN';
                const isHQ = !isAdmin; // Anyone who is not Admin is regular HQ
                
                if (isAdmin) {
                    // ADMIN USERS: All functions including delete and reward
                    userPermissions = {
                        canViewAllOutlets: true,
                        canAddOutlets: true,
                        allowedOutlets: allOutlets.length > 0 ? allOutlets.map(outlet => outlet.code) : ['DEMO01', 'DEMO02', 'DEMO03'],
                        canAssignOKR: true,
                        canEditOKR: true,
                        canDeleteOKR: true, // ADMIN ONLY: Can delete OKR cards
                        canRewardMedals: true, // ADMIN ONLY: Can reward outlets with medals
                        canComment: true,
                        canLike: true,
                        role: 'Admin'
                    };
                    console.log('👑 Admin permissions set - full access to all functions');
                } else {
                    // HQ USERS (AM, SUPERVISOR, etc.): All functions EXCEPT delete and reward
                    const hqOutlets = currentUser.accessibleOutlets === 'ALL' || !currentUser.accessibleOutlets || currentUser.accessibleOutlets.length === 0
                        ? (allOutlets.length > 0 ? allOutlets.map(outlet => outlet.code) : ['DEMO01', 'DEMO02', 'DEMO03'])
                        : currentUser.accessibleOutlets;
                        
                    userPermissions = {
                        canViewAllOutlets: true, // HQ can see all outlets
                        canAddOutlets: true, // HQ can add new outlets to Phoenix
                        allowedOutlets: hqOutlets,
                        canAssignOKR: true, // HQ can assign OKRs
                        canEditOKR: true, // HQ can edit OKRs
                        canDeleteOKR: false, // HQ CANNOT delete OKR cards (Admin only)
                        canRewardMedals: false, // HQ CANNOT reward medals (Admin only)
                        canComment: true, // HQ can comment
                        canLike: true, // HQ can like
                        role: currentUser.role || 'HQ'
                    };
                    console.log('🏢 HQ permissions set - can access all outlets but no delete/reward');
                    console.log('📋 HQ accessible outlets:', hqOutlets.length, 'outlets');
                }
                
            } else if (currentUser.type === 'am') {
                // Legacy AM support - treat as HQ user
                userPermissions = {
                    canViewAllOutlets: false,
                    canAddOutlets: true,
                    allowedOutlets: allOutlets.filter(outlet => 
                        outlet.am === currentUser.name || outlet.am === 'SYSTEM AM'
                    ).map(outlet => outlet.code),
                    canAssignOKR: true,
                    canEditOKR: true,
                    canDeleteOKR: false, // Legacy AM cannot delete
                    canRewardMedals: false, // Legacy AM cannot reward
                    canComment: true,
                    canLike: true,
                    role: 'AM'
                };
                console.log('📊 Legacy AM permissions set');
            } else {
                // Fallback/default permissions (assumed admin for safety)
                userPermissions = {
                    canViewAllOutlets: true,
                    canAddOutlets: true,
                    allowedOutlets: allOutlets.length > 0 ? allOutlets.map(outlet => outlet.code) : ['DEMO01', 'DEMO02', 'DEMO03'],
                    canAssignOKR: true,
                    canEditOKR: true,
                    canDeleteOKR: true,
                    canRewardMedals: true,
                    canComment: true,
                    canLike: true,
                    role: 'Admin'
                };
                console.log('⚠️ Fallback admin permissions set');
            }
            
            // Update UI based on permissions
            try {
                const userMedals = getUserMedals();
                const medalDisplay = userMedals.length > 0 ? `${userMedals.slice(0, 3).map(m => m.tierEmoji).join('')} ` : '';
                
                // Get role display name from permissions (which now reflects the Google Sheets role)
                const roleDisplay = userPermissions.role || getUserRoleDisplay(currentUser);
                
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = `👋 ${medalDisplay}${currentUser.name || currentUser.username} (${roleDisplay})`;
                }
            } catch (error) {
                console.error('❌ Error setting up user display:', error);
                
                // Get role display name for fallback
                const roleDisplay = userPermissions?.role || getUserRoleDisplay(currentUser);
                
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    userNameElement.textContent = `👋 ${currentUser.name || currentUser.username} (${roleDisplay})`;
                }
            }
        }

        // Load Phoenix data from cloud storage for cross-device access
        async function loadPhoenixDataFromCloud() {
            try {
                console.log('☁️ Loading Phoenix data from cloud storage for cross-device access...');
                
                // Try cloud storage first (JSONBin - immediate cross-device functionality)
                if (typeof SimpleCloudStorage !== 'undefined') {
                    const cloudStorage = new SimpleCloudStorage();
                    const loadedPhoenixData = await cloudStorage.loadPhoenixData();
                    
                    // Merge with any existing localStorage data
                    const localData = JSON.parse(localStorage.getItem('phoenixProjectData')) || { outlets: {} };
                    
                    // Prioritize cloud data, but preserve local data if cloud is empty
                    if (Object.keys(loadedPhoenixData.outlets).length > 0) {
                        phoenixData = loadedPhoenixData;
                        console.log('✅ Loaded Phoenix data from cloud storage (primary source)');
                        console.log('📊 Outlets from cloud:', Object.keys(phoenixData.outlets).length);
                        
                        // Update localStorage with cloud data for offline access
                        localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
                    } else if (Object.keys(localData.outlets).length > 0) {
                        phoenixData = localData;
                        console.log('⚠️ No data in cloud, using localStorage data');
                        console.log('📊 Outlets from localStorage:', Object.keys(phoenixData.outlets).length);
                        
                        // Automatically sync local data to cloud
                        console.log('🔄 Syncing local data to cloud storage...');
                        try {
                            const success = await cloudStorage.savePhoenixData(phoenixData);
                            if (success) {
                                console.log('✅ Local data automatically synced to cloud');
                                showNotification('✅ Data synced to cloud for cross-device access!', 'success');
                            }
                        } catch (syncError) {
                            console.warn('⚠️ Could not sync to cloud:', syncError);
                        }
                    } else {
                        phoenixData = { outlets: {} };
                        console.log('ℹ️ No Phoenix data found in cloud or localStorage - starting fresh');
                    }
                } else {
                    console.warn('⚠️ Cloud storage API not available, falling back to localStorage only');
                    phoenixData = JSON.parse(localStorage.getItem('phoenixProjectData')) || { outlets: {} };
                }
                
                console.log('📈 Final Phoenix data summary:', {
                    totalOutlets: Object.keys(phoenixData.outlets).length,
                    outletsWithOKR: Object.keys(phoenixData.outlets).filter(code => phoenixData.outlets[code].okr).length,
                    outletsWithPerformance: Object.keys(phoenixData.outlets).filter(code => phoenixData.outlets[code].performanceData).length
                });
                
            } catch (error) {
                console.error('❌ Failed to load Phoenix data from cloud:', error);
                
                // Fallback to localStorage
                phoenixData = JSON.parse(localStorage.getItem('phoenixProjectData')) || { outlets: {} };
                console.log('📋 Using localStorage fallback data');
            }
        }

        // Centralized Phoenix data save function for cross-device persistence
        function savePhoenixData(description = 'Phoenix data updated') {
            try {
                console.log(`💾 Saving Phoenix data: ${description}`);
                
                // Save to localStorage for immediate access and offline use
                localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
                console.log('✅ Phoenix data saved to localStorage');
                
                // Save to cloud storage for cross-device access (background operation)
                if (typeof SimpleCloudStorage !== 'undefined') {
                    const cloudStorage = new SimpleCloudStorage();
                    cloudStorage.savePhoenixData(phoenixData)
                        .then((success) => {
                            if (success) {
                                console.log('✅ Phoenix data synced to cloud successfully');
                            } else {
                                console.warn('⚠️ Failed to sync Phoenix data to cloud');
                            }
                        })
                        .catch(error => {
                            console.warn('⚠️ Cloud sync error:', error);
                        });
                } else {
                    console.log('ℹ️ Cloud storage not available - data saved locally only');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Failed to save Phoenix data:', error);
                
                // Ensure localStorage is at least updated
                try {
                    localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
                    console.log('📋 Fallback: Data saved to localStorage only');
                } catch (localError) {
                    console.error('❌ Critical: Failed to save to localStorage:', localError);
                }
                
                return false;
            }
        }

        function loadPhoenixOutlets() {
            console.log('🔄 Loading Phoenix outlets from cross-device data...');
            console.log('📊 Available Phoenix outlet codes:', Object.keys(phoenixData.outlets));
            console.log('📊 Available outlets from Google Sheets:', allOutlets.length ? allOutlets.map(o => o.code) : 'No Google Sheets data');
            
            // Create a map of outlet codes from Google Sheets for quick lookup
            const googleSheetsOutletMap = {};
            allOutlets.forEach(outlet => {
                googleSheetsOutletMap[outlet.code] = outlet;
            });
            
            // Build Phoenix outlets from localStorage data
            phoenixOutlets = [];
            
            // Iterate through all Phoenix outlets stored in localStorage
            Object.keys(phoenixData.outlets).forEach(outletCode => {
                const phoenixOutletData = phoenixData.outlets[outletCode];
                
                // Check if user has permission to view this outlet
                const canViewOutlet = userPermissions.canViewAllOutlets || 
                                    userPermissions.allowedOutlets.includes(outletCode);
                
                if (canViewOutlet) {
                    // Use Google Sheets data if available, otherwise create synthetic outlet data
                    const baseOutletData = googleSheetsOutletMap[outletCode] || {
                        id: Math.floor(Math.random() * 10000), // Generate random ID
                        code: outletCode,
                        name: `APOTEK ALPRO ${outletCode}`, // Generate name from code
                        am: currentUser?.username || 'Phoenix AM' // Use current user or default
                    };
                    
                    // Combine base outlet data with Phoenix-specific data
                    const combinedOutlet = {
                        ...baseOutletData,
                        ...phoenixOutletData
                    };
                    
                    phoenixOutlets.push(combinedOutlet);
                    console.log(`✅ Loaded Phoenix outlet: ${outletCode} (${combinedOutlet.name})`);
                } else {
                    console.log(`⚠️ Skipping Phoenix outlet ${outletCode} - user has no permission`);
                }
            });
            
            console.log(`✅ Successfully loaded ${phoenixOutlets.length} Phoenix outlets for user`);
            console.log('📋 Phoenix outlets summary:', phoenixOutlets.map(o => ({code: o.code, name: o.name, hasOKR: !!o.okr})));
            
            // Save updated Phoenix data to ensure cross-device persistence
            if (phoenixOutlets.length > 0) {
                savePhoenixData('Phoenix outlets loaded and verified');
            }
        }

        function renderPhoenixDashboard() {
            // Clear cache when dashboard refreshes to ensure fresh data
            clearTierUnlockCache();
            
            // Update stats
            const totalRevenue = phoenixOutlets.reduce((sum, outlet) => {
                const performanceData = outlet.performanceData || {};
                return sum + (performanceData.term1?.revenue || 0) + (performanceData.term2?.revenue || 0) + (performanceData.term3?.revenue || 0);
            }, 0);
            
            // Calculate average progress based on data completion
            const avgProgress = phoenixOutlets.length > 0 ? 
                Math.round(phoenixOutlets.reduce((sum, outlet) => sum + calculateOutletProgress(outlet), 0) / phoenixOutlets.length) : 0;
            
            document.getElementById('total-phoenix-outlets').textContent = phoenixOutlets.length;
            document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('avg-progress').textContent = avgProgress + '%';
            
            // Render cards and medal showcase
            renderOutletCards();
            renderMedalShowcase();
        }

        function calculateOutletProgress(outlet) {
            // Calculate progress based on OKR action plan completion, not data entry
            if (!outlet.okr || !outlet.okr.actionPlans) {
                return 0; // No OKR assigned
            }
            
            const krProgressData = outlet.okr.krProgress || {};
            let totalActions = 0;
            let completedActions = 0;
            
            // Count total and completed actions across all KRs
            ['kr1', 'kr2', 'kr3', 'kr4', 'kr5'].forEach(krKey => {
                const actionPlans = outlet.okr.actionPlans[krKey] || [];
                const completed = krProgressData[krKey]?.completedActions || [];
                totalActions += actionPlans.length;
                completedActions += completed.length;
            });
            
            // Calculate overall progress
            return totalActions > 0 ? Math.round((completedActions / totalActions) * 100) : 0;
        }

        function renderOutletCards() {
            try {
                const outletsGrid = document.getElementById('outlets-grid');
                const emptyState = document.getElementById('empty-state');
                
                if (!outletsGrid) {
                    console.error('❌ outlets-grid element not found');
                    return;
                }
                
                if (phoenixOutlets.length === 0) {
                    if (outletsGrid) outletsGrid.style.display = 'none';
                    if (emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                outletsGrid.style.display = 'grid';
                if (emptyState) emptyState.style.display = 'none';
                
                // Show loading state first for better perceived performance
                outletsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #667eea;">🔄 Loading outlet cards...</div>';
                
                // Use requestAnimationFrame for better performance
                requestAnimationFrame(() => {
                    outletsGrid.innerHTML = phoenixOutlets.map(outlet => {
                    try {
                const progress = calculateOutletProgress(outlet);
                const performanceData = outlet.performanceData || {};
                const totalRevenue = (performanceData.term1?.revenue || 0) + (performanceData.term2?.revenue || 0) + (performanceData.term3?.revenue || 0);
                const totalTrano = (performanceData.term1?.trano || 0) + (performanceData.term2?.trano || 0) + (performanceData.term3?.trano || 0);
                
                // Calculate OKR Key Results progress instead of data entry progress
                let kr1Progress = 0, kr2Progress = 0, kr3Progress = 0;
                
                if (outlet.okr && outlet.okr.keyResults) {
                    // Calculate progress for each KR based on completed action plans
                    const krProgressData = outlet.okr.krProgress || {};
                    
                    // KR1 progress (if exists)
                    if (outlet.okr.keyResults[0]) {
                        const kr1ActionPlans = outlet.okr.actionPlans?.kr1 || [];
                        const kr1Completed = krProgressData.kr1?.completedActions || [];
                        kr1Progress = kr1ActionPlans.length > 0 ? Math.round((kr1Completed.length / kr1ActionPlans.length) * 100) : 0;
                    }
                    
                    // KR2 progress (if exists) 
                    if (outlet.okr.keyResults[1]) {
                        const kr2ActionPlans = outlet.okr.actionPlans?.kr2 || [];
                        const kr2Completed = krProgressData.kr2?.completedActions || [];
                        kr2Progress = kr2ActionPlans.length > 0 ? Math.round((kr2Completed.length / kr2ActionPlans.length) * 100) : 0;
                    }
                    
                    // KR3 progress (if exists)
                    if (outlet.okr.keyResults[2]) {
                        const kr3ActionPlans = outlet.okr.actionPlans?.kr3 || [];
                        const kr3Completed = krProgressData.kr3?.completedActions || [];
                        kr3Progress = kr3ActionPlans.length > 0 ? Math.round((kr3Completed.length / kr3ActionPlans.length) * 100) : 0;
                    }
                } else {
                    // No OKR assigned - show 0% progress
                    kr1Progress = kr2Progress = kr3Progress = 0;
                }
                
                const term1Progress = kr1Progress;
                const term2Progress = kr2Progress; 
                const term3Progress = kr3Progress;
                
                // Add admin controls for delete functionality
                const adminControls = userPermissions && userPermissions.canDeleteOKR ? `
                    <div class="admin-controls" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                        <button class="delete-okr-btn" onclick="event.stopPropagation(); deleteOutletOKR('${outlet.code}')" 
                                style="background: #e53e3e; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" 
                                title="Delete OKR Card">🗑️</button>
                    </div>
                ` : '';
                
                return `
                    <div class="phoenix-outlet-card" onclick="showOutletDetail('${outlet.code}')" style="position: relative;">
                        ${adminControls}
                        <div class="outlet-header">
                            <div class="outlet-info">
                                <h3>${outlet.name}</h3>
                                <div class="outlet-code">Code: ${outlet.code} | AM: ${outlet.am}</div>
                            </div>
                            <div class="phoenix-badge">🔥 Phoenix</div>
                        </div>

                        <div class="performance-metrics">
                            <div class="metric-item">
                                <div class="metric-value">${formatCurrency(totalRevenue)}</div>
                                <div class="metric-label">Total Revenue</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${totalTrano.toLocaleString()}</div>
                                <div class="metric-label">Total Trano</div>
                            </div>
                        </div>

                        ${renderTierUnlockBar(outlet, totalRevenue)}

                        <div class="progress-section">
                            <div class="progress-title">🎯 OKR Key Results Progress</div>
                            <div class="progress-bars">
                                <div class="progress-item">
                                    <div class="progress-label">KR1</div>
                                    <div class="progress-value">${term1Progress}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(term1Progress, 100)}%"></div>
                                    </div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">KR2</div>
                                    <div class="progress-value">${term2Progress}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(term2Progress, 100)}%"></div>
                                    </div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">KR3</div>
                                    <div class="progress-value">${term3Progress}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(term3Progress, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${outlet.okr ? `
                                    <div style="background: #e6fffa; color: #38a169; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                        🎯 OKR Assigned
                                    </div>
                                ` : `
                                    <div style="background: #fef5e7; color: #d69e2e; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                        ⚠️ No OKR
                                    </div>
                                `}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="event.stopPropagation(); assignOKR('${outlet.code}')" 
                                        style="background: #48bb78; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                                    ${outlet.okr ? '✏️ Edit OKR' : '🎯 Assign OKR'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                    } catch (error) {
                        console.error('❌ Error rendering outlet card:', outlet.code, error);
                        console.error('❌ Outlet data causing error:', outlet);
                        return `
                            <div class="phoenix-outlet-card" style="background: #fed7d7; border: 1px solid #e53e3e; border-radius: 12px; padding: 20px;">
                                <div style="text-align: center; color: #e53e3e;">
                                    <div style="font-size: 1.5rem; margin-bottom: 10px;">⚠️</div>
                                    <div style="font-weight: 600; margin-bottom: 8px;">Error loading outlet: ${outlet.code}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 12px;">
                                        ${outlet.name || 'Unknown outlet name'}
                                    </div>
                                    <div style="font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px;">
                                        Error: ${error.message || 'Unknown rendering error'}
                                    </div>
                                    <button onclick="event.stopPropagation(); fixOutletData('${outlet.code}')" 
                                            style="background: #48bb78; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-top: 10px;">
                                        🔧 Try to Fix
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    }).join('');
                });
            } catch (error) {
                console.error('❌ Error rendering outlet cards:', error);
                const outletsGrid = document.getElementById('outlets-grid');
                if (outletsGrid) {
                    outletsGrid.innerHTML = `
                        <div style="background: #fed7d7; border: 1px solid #e53e3e; border-radius: 12px; padding: 20px; text-align: center; color: #e53e3e;">
                            <div style="font-size: 1.5rem; margin-bottom: 10px;">⚠️</div>
                            <div>Error loading outlet cards</div>
                        </div>
                    `;
                }
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function fixOutletData(outletCode) {
            console.log(`🔧 Attempting to fix outlet data for: ${outletCode}`);
            
            // Reset outlet data to a clean state
            if (!phoenixData.outlets[outletCode]) {
                phoenixData.outlets[outletCode] = {};
            }
            
            // Ensure basic structure exists
            if (!phoenixData.outlets[outletCode].performanceData) {
                phoenixData.outlets[outletCode].performanceData = {
                    term1: { revenue: 0, trano: 0 },
                    term2: { revenue: 0, trano: 0 },
                    term3: { revenue: 0, trano: 0 }
                };
            }
            
            // Save to cross-device storage
            savePhoenixData('OKR data updated');
            
            // Refresh the dashboard
            loadPhoenixOutlets();
            renderOutletCards();
            
            showNotification(`🔧 Fixed data structure for outlet ${outletCode}`, 'success');
        }

        function deleteOutletOKR(outletCode) {
            // Check permissions
            if (!userPermissions || !userPermissions.canDeleteOKR) {
                showNotification('❌ You do not have permission to delete OKR cards', 'error');
                return;
            }
            
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet) {
                showNotification('❌ Outlet not found', 'error');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete the OKR card for ${outlet.name} (${outletCode})?\n\nThis will remove:\n- All OKR data and progress\n- Action plans and comments\n- Performance data\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                // Remove outlet from Phoenix data
                if (phoenixData.outlets[outletCode]) {
                    delete phoenixData.outlets[outletCode];
                }
                
                // Save to cross-device storage
                savePhoenixData('Performance data updated');
                
                // Remove from phoenixOutlets array
                const outletIndex = phoenixOutlets.findIndex(o => o.code === outletCode);
                if (outletIndex >= 0) {
                    phoenixOutlets.splice(outletIndex, 1);
                }
                
                // Remove from performance data in localStorage
                const performanceData = JSON.parse(localStorage.getItem('outletPerformanceData') || '{}');
                if (performanceData[outletCode]) {
                    delete performanceData[outletCode];
                    localStorage.setItem('outletPerformanceData', JSON.stringify(performanceData));
                }
                
                // Remove medal data for this outlet
                const userMedals = JSON.parse(localStorage.getItem('userMedals') || '{}');
                Object.keys(userMedals).forEach(username => {
                    if (userMedals[username] && userMedals[username].medals) {
                        userMedals[username].medals = userMedals[username].medals.filter(
                            medal => medal.outletCode !== outletCode
                        );
                        // Recalculate total rewards
                        userMedals[username].totalRewards = userMedals[username].medals.reduce(
                            (sum, medal) => sum + medal.rewardAmount, 0
                        );
                    }
                });
                localStorage.setItem('userMedals', JSON.stringify(userMedals));
                
                // Re-render the dashboard
                renderOutletCards();
                renderMedalShowcase();
                
                showNotification(`🗑️ Successfully deleted OKR card for ${outlet.name}`, 'success');
                console.log(`✅ Admin deleted OKR card for outlet: ${outletCode} by user: ${currentUser.name || currentUser.username}`);
                
            } catch (error) {
                console.error('❌ Error deleting outlet OKR:', error);
                showNotification('❌ Error deleting OKR card. Check console for details.', 'error');
            }
        }

        // Medal Reward System Functions
        let selectedMedalType = null;
        let selectedMedalTier = null;

        function openRewardMedalModal() {
            // Check permissions
            if (!userPermissions || !userPermissions.canRewardMedals) {
                showNotification('❌ You do not have permission to award medals', 'error');
                return;
            }
            
            // Populate outlet dropdown
            const outletSelect = document.getElementById('reward-outlet-select');
            outletSelect.innerHTML = '<option value="">Choose an outlet...</option>';
            
            // Add all Phoenix outlets to the dropdown
            phoenixOutlets.forEach(outlet => {
                const option = document.createElement('option');
                option.value = outlet.code;
                option.textContent = `${outlet.name} (${outlet.code})`;
                outletSelect.appendChild(option);
            });
            
            // Reset form
            selectedMedalType = null;
            selectedMedalTier = null;
            document.getElementById('reward-amount').value = '';
            document.getElementById('reward-reason').value = '';
            
            // Reset button styles
            document.querySelectorAll('.medal-type-btn').forEach(btn => {
                btn.style.border = '2px solid #e2e8f0';
                btn.style.background = 'white';
            });
            document.querySelectorAll('.medal-tier-btn').forEach(btn => {
                btn.style.border = '2px solid #e2e8f0';
                btn.style.background = 'white';
            });
            
            // Show modal
            document.getElementById('reward-medal-modal').style.display = 'flex';
        }

        function selectMedalType(type) {
            selectedMedalType = type;
            
            // Update button styles
            document.querySelectorAll('.medal-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.border = '2px solid #667eea';
                    btn.style.background = '#f7fafc';
                } else {
                    btn.style.border = '2px solid #e2e8f0';
                    btn.style.background = 'white';
                }
            });
            
            // Set suggested reward amounts based on type
            const rewardAmount = document.getElementById('reward-amount');
            switch (type) {
                case 'most_improved':
                    rewardAmount.value = '750000';
                    break;
                case 'most_compliant':
                    rewardAmount.value = '500000';
                    break;
                case 'early_achiever':
                    rewardAmount.value = '1000000';
                    break;
                case 'excellence':
                    rewardAmount.value = '1250000';
                    break;
            }
        }

        function selectMedalTier(tier) {
            selectedMedalTier = tier;
            
            // Update button styles
            document.querySelectorAll('.medal-tier-btn').forEach(btn => {
                if (parseInt(btn.dataset.tier) === tier) {
                    btn.style.border = '2px solid #667eea';
                    btn.style.background = '#f7fafc';
                } else {
                    btn.style.border = '2px solid #e2e8f0';
                    btn.style.background = 'white';
                }
            });
        }

        function awardSpecialMedal() {
            const outletCode = document.getElementById('reward-outlet-select').value;
            const rewardAmount = parseFloat(document.getElementById('reward-amount').value) || 0;
            const reason = document.getElementById('reward-reason').value.trim();
            
            // Validation
            if (!outletCode) {
                showNotification('❌ Please select an outlet', 'error');
                return;
            }
            
            if (!selectedMedalType) {
                showNotification('❌ Please select a medal type', 'error');
                return;
            }
            
            if (!selectedMedalTier) {
                showNotification('❌ Please select a medal tier', 'error');
                return;
            }
            
            if (rewardAmount <= 0) {
                showNotification('❌ Please enter a valid reward amount', 'error');
                return;
            }
            
            if (!reason) {
                showNotification('❌ Please provide a reason for awarding this medal', 'error');
                return;
            }
            
            try {
                // Get medal type info
                const medalTypeInfo = getMedalTypeInfo(selectedMedalType);
                const tierEmoji = selectedMedalTier === 3 ? '🥇' : selectedMedalTier === 2 ? '🥈' : '🥉';
                const tierName = selectedMedalTier === 3 ? 'Gold' : selectedMedalTier === 2 ? 'Silver' : 'Bronze';
                
                // Create special medal data
                const specialMedal = {
                    outletCode: outletCode,
                    tier: selectedMedalTier,
                    tierEmoji: tierEmoji,
                    tierName: tierName,
                    medalType: selectedMedalType,
                    medalTypeEmoji: medalTypeInfo.emoji,
                    medalTypeName: medalTypeInfo.name,
                    rewardAmount: rewardAmount,
                    achievedDate: new Date().toISOString(),
                    awardedBy: currentUser.name || currentUser.username,
                    reason: reason,
                    isSpecialAward: true
                };
                
                // Add to current user's medals (admin awards medals to system/all users can see)
                const userMedals = JSON.parse(localStorage.getItem('userMedals') || '{}');
                
                // Create a special entry for admin-awarded medals
                const adminUsername = 'ADMIN_AWARDS';
                if (!userMedals[adminUsername]) {
                    userMedals[adminUsername] = {
                        medals: [],
                        totalRewards: 0
                    };
                }
                
                userMedals[adminUsername].medals.push(specialMedal);
                userMedals[adminUsername].totalRewards += rewardAmount;
                
                // Also add to the specific outlet's performance record
                const outlet = phoenixOutlets.find(o => o.code === outletCode);
                if (outlet) {
                    if (!phoenixData.outlets[outletCode].specialMedals) {
                        phoenixData.outlets[outletCode].specialMedals = [];
                    }
                    phoenixData.outlets[outletCode].specialMedals.push(specialMedal);
                    localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
                }
                
                localStorage.setItem('userMedals', JSON.stringify(userMedals));
                
                // Re-render showcase
                renderMedalShowcase();
                renderOutletCards();
                
                // Close modal
                closeRewardMedalModal();
                
                showNotification(`🏆 ${tierName} ${medalTypeInfo.name} medal awarded to ${outlet?.name || outletCode}!`, 'success');
                console.log(`✅ Admin awarded special medal: ${tierName} ${medalTypeInfo.name} to ${outletCode} by ${currentUser.name || currentUser.username}`);
                
            } catch (error) {
                console.error('❌ Error awarding special medal:', error);
                showNotification('❌ Error awarding medal. Check console for details.', 'error');
            }
        }

        function getMedalTypeInfo(type) {
            const types = {
                'most_improved': { name: 'Most Improved', emoji: '📈' },
                'most_compliant': { name: 'Most Compliant', emoji: '✅' },
                'early_achiever': { name: 'Early Achiever', emoji: '⚡' },
                'excellence': { name: 'Excellence', emoji: '⭐' }
            };
            return types[type] || { name: 'Special', emoji: '🏆' };
        }

        function closeRewardMedalModal() {
            document.getElementById('reward-medal-modal').style.display = 'none';
            selectedMedalType = null;
            selectedMedalTier = null;
        }

        function renderSalesTargetSystem(outlet, currentRevenue) {
            try {
                // Validate inputs
                if (!outlet) {
                    console.error('❌ renderSalesTargetSystem: outlet is null or undefined');
                    return '<div style="color: red;">Error: Invalid outlet data</div>';
                }
                
                if (typeof currentRevenue !== 'number' || isNaN(currentRevenue)) {
                    console.warn('⚠️ renderSalesTargetSystem: currentRevenue is not a valid number, using 0');
                    currentRevenue = 0;
                }
                
                // Get sales target data from outlet or initialize if not exists
                const salesTargetData = outlet.salesTarget || {};
                const monthlyTarget = salesTargetData.monthlyTarget || 0;
            
            // Calculate tier targets
            const tier1Target = Math.round(monthlyTarget * 0.8); // 80%
            const tier2Target = Math.round(monthlyTarget * 0.9); // 90%
            const tier3Target = monthlyTarget; // 100%
            
            // Calculate achievement percentage
            const achievementPercentage = monthlyTarget > 0 ? Math.round((currentRevenue / monthlyTarget) * 100) : 0;
            
            // Determine current tier and rewards
            let currentTier = 0;
            let rewardPercentage = 0;
            let tierName = "Not Qualified";
            let medalEmoji = "⚪";
            
            if (currentRevenue >= tier3Target) {
                currentTier = 3;
                rewardPercentage = 2.7;
                tierName = "🥇 Tier 3 - Gold";
                medalEmoji = "🥇";
            } else if (currentRevenue >= tier2Target) {
                currentTier = 2;
                rewardPercentage = 2.0;
                tierName = "🥈 Tier 2 - Silver";
                medalEmoji = "🥈";
            } else if (currentRevenue >= tier1Target) {
                currentTier = 1;
                rewardPercentage = 1.35;
                tierName = "🥉 Tier 1 - Bronze";
                medalEmoji = "🥉";
            }
            
            // Calculate reward amount
            const rewardAmount = Math.round(currentRevenue * (rewardPercentage / 100));
            
            // Save medal achievement to user profile
            if (currentTier > 0) {
                saveMedalAchievement(outlet.code, currentTier, rewardAmount);
            }
            
            return `
                <div class="sales-target-system" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 16px; margin: 15px 0; color: white;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: white; margin: 0; font-size: 0.95rem;">🎯 Monthly Sales Target System</h4>
                        <div style="font-size: 1.5rem;">${medalEmoji}</div>
                    </div>
                    
                    <!-- Target Input Section -->
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 4px; color: rgba(255,255,255,0.9);">
                            100% Monthly Target (Tier 3):
                        </label>
                        <input type="number" 
                               id="monthly-target-${outlet.code}" 
                               value="${monthlyTarget}" 
                               onchange="updateMonthlyTarget('${outlet.code}', this.value)"
                               style="width: 100%; padding: 6px; border: none; border-radius: 4px; font-size: 0.85rem;"
                               placeholder="Enter monthly sales target">
                    </div>
                    
                    ${monthlyTarget > 0 ? `
                        <!-- Tier Progress Display -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 0.9rem; font-weight: 600;">${tierName}</span>
                                <span style="font-size: 0.9rem; font-weight: 600;">${achievementPercentage}%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; overflow: hidden;">
                                <div style="background: ${currentTier >= 3 ? '#ffd700' : currentTier >= 2 ? '#c0c0c0' : currentTier >= 1 ? '#cd7f32' : '#48bb78'}; height: 100%; width: ${Math.min(achievementPercentage, 100)}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Tier Targets -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                            <div style="background: rgba(205,127,50,0.3); border: 2px solid ${currentTier >= 1 ? '#cd7f32' : 'rgba(255,255,255,0.3)'}; border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.9;">🥉 Tier 1 (80%)</div>
                                <div style="font-size: 0.8rem; font-weight: 600;">${formatCurrency(tier1Target)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">1.35% reward</div>
                            </div>
                            <div style="background: rgba(192,192,192,0.3); border: 2px solid ${currentTier >= 2 ? '#c0c0c0' : 'rgba(255,255,255,0.3)'}; border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.9;">🥈 Tier 2 (90%)</div>
                                <div style="font-size: 0.8rem; font-weight: 600;">${formatCurrency(tier2Target)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">2.0% reward</div>
                            </div>
                            <div style="background: rgba(255,215,0,0.3); border: 2px solid ${currentTier >= 3 ? '#ffd700' : 'rgba(255,255,255,0.3)'}; border-radius: 6px; padding: 6px; text-align: center;">
                                <div style="font-size: 0.7rem; opacity: 0.9;">🥇 Tier 3 (100%)</div>
                                <div style="font-size: 0.8rem; font-weight: 600;">${formatCurrency(tier3Target)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">2.7% reward</div>
                            </div>
                        </div>
                        
                        ${currentTier > 0 ? `
                            <!-- Reward Display -->
                            <div style="background: rgba(72,187,120,0.3); border: 1px solid #48bb78; border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px;">🎉 Congratulations! Your Reward:</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #48bb78;">${formatCurrency(rewardAmount)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">(${rewardPercentage}% of revenue)</div>
                            </div>
                        ` : `
                            <!-- Motivation Display -->
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9;">Keep pushing! You need ${formatCurrency(tier1Target - currentRevenue)} more to reach Tier 1 🥉</div>
                            </div>
                        `}
                    ` : `
                        <!-- No Target Set -->
                        <div style="text-align: center; opacity: 0.8; font-size: 0.85rem;">
                            Set your monthly target to see tier progress and rewards
                        </div>
                    `}
                </div>
            `;
            } catch (error) {
                console.error('❌ Error in renderSalesTargetSystem:', error);
                console.error('❌ Outlet data:', outlet);
                console.error('❌ Current revenue:', currentRevenue);
                return `
                    <div class="sales-target-system" style="background: #fed7d7; border: 1px solid #e53e3e; border-radius: 12px; padding: 16px; margin: 15px 0; color: #e53e3e;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; margin-bottom: 8px;">⚠️</div>
                            <div style="font-size: 0.9rem;">Sales target system temporarily unavailable</div>
                            <div style="font-size: 0.75rem; margin-top: 4px; opacity: 0.8;">Error: ${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        function updateMonthlyTarget(outletCode, targetValue) {
            const target = parseFloat(targetValue) || 0;
            
            // Initialize outlet data if it doesn't exist
            if (!phoenixData.outlets[outletCode]) {
                phoenixData.outlets[outletCode] = {};
            }
            
            // Update sales target
            phoenixData.outlets[outletCode].salesTarget = {
                monthlyTarget: target,
                lastUpdated: new Date().toISOString()
            };
            
            // Update local outlet data
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (outlet) {
                outlet.salesTarget = phoenixData.outlets[outletCode].salesTarget;
            }
            
            // Save to cross-device storage
            savePhoenixData('OKR data updated');
            
            // Refresh the outlet cards to show updated targets
            renderOutletCards();
            renderPhoenixDashboard();
            
            showNotification(`🎯 Monthly target updated to ${formatCurrency(target)}`, 'success');
            console.log(`✅ Updated monthly target for ${outletCode} to ${target}`);
        }
        
        // Cache for tier unlock bars to avoid recalculating
        const tierUnlockCache = new Map();
        
        // Clear cache when outlet data changes
        function clearTierUnlockCache() {
            tierUnlockCache.clear();
        }
        
        // Get user role display name
        function getUserRoleDisplay(user) {
            if (!user || !user.type) return 'User';
            
            // For HQ users, use their specific role from Google Sheets (column D)
            if (user.type === 'hq' && user.role) {
                switch (user.role.toUpperCase()) {
                    case 'ADMIN':
                        return 'Admin';
                    case 'AM':
                    case 'AREA_MANAGER':
                        return 'Area Manager';
                    case 'SUPERVISOR':
                        return 'Supervisor';
                    case 'MANAGER':
                        return 'Manager';
                    default:
                        return user.role.charAt(0).toUpperCase() + user.role.slice(1).toLowerCase();
                }
            }
            
            switch (user.type.toLowerCase()) {
                case 'admin':
                case 'administrator':
                    return 'Admin';
                case 'am':
                case 'area_manager':
                    return 'Area Manager';
                case 'outlet':
                case 'outlet_manager':
                    return 'Outlet Manager';
                case 'supervisor':
                    return 'Supervisor';
                case 'manager':
                    return 'Manager';
                default:
                    // Capitalize first letter of any other role
                    return user.type.charAt(0).toUpperCase() + user.type.slice(1);
            }
        }
        
        function renderTierUnlockBar(outlet, currentRevenue) {
            try {
                // Create cache key based on outlet and revenue
                const cacheKey = `${outlet.code}_${currentRevenue}`;
                
                // Check cache first for performance
                if (tierUnlockCache.has(cacheKey)) {
                    return tierUnlockCache.get(cacheKey);
                }
                
                // Get monthly target from detail view or localStorage
                const detailTargetKey = `detail_monthly_target_${outlet.code}`;
                let monthlyTarget = 0;
                
                // Check localStorage for detail view target
                const savedTarget = localStorage.getItem(detailTargetKey);
                if (savedTarget) {
                    monthlyTarget = parseFloat(savedTarget);
                } else if (phoenixData && phoenixData.outlets && phoenixData.outlets[outlet.code] && phoenixData.outlets[outlet.code].salesTargets) {
                    monthlyTarget = phoenixData.outlets[outlet.code].salesTargets.monthlyTarget || 0;
                }
                
                // Use actual revenue from outlet performance data instead of passed parameter
                // Get the actual Term data for this outlet to calculate real revenue
                const performanceData = outlet.performanceData || {
                    term1: { revenue: 0, trano: 0 },
                    term2: { revenue: 0, trano: 0 },
                    term3: { revenue: 0, trano: 0 }
                };
                
                // Calculate actual revenue based on available term data
                let actualRevenue = 0;
                const term1Rev = performanceData.term1.revenue || 0;
                const term2Rev = performanceData.term2.revenue || 0;
                const term3Rev = performanceData.term3.revenue || 0;
                
                if (term3Rev > 0) {
                    // If Term 3 has data, use all three terms
                    actualRevenue = term1Rev + term2Rev + term3Rev;
                } else if (term2Rev > 0) {
                    // If Term 2 has data but Term 3 doesn't, use Term 1 + Term 2
                    actualRevenue = term1Rev + term2Rev;
                } else if (term1Rev > 0) {
                    // If only Term 1 has data, use Term 1 only
                    actualRevenue = term1Rev;
                } else {
                    // No term data available, use 0
                    actualRevenue = 0;
                }
                
                // Use actualRevenue instead of currentRevenue for calculations
                currentRevenue = actualRevenue;
                
                // Calculate tier targets (only if target is set)
                if (monthlyTarget <= 0) {
                    // No target set - show locked tiers
                    const result = `
                        <div class="tier-unlock-bar" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%); border-radius: 8px; padding: 12px; margin: 10px 0; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 0.85rem; opacity: 0.9;">🏆 Achievement Tiers</span>
                                <span style="font-size: 0.75rem; opacity: 0.7;">Set target in detail view</span>
                            </div>
                            
                            <!-- Progress Bar with Lock Icons and Labels -->
                            <div style="position: relative; background: rgba(255,255,255,0.2); border-radius: 10px; height: 12px; margin-bottom: 25px; overflow: visible;">
                                <div style="background: rgba(255,255,255,0.1); height: 100%; width: 0%; border-radius: 10px;"></div>
                                
                                <!-- Lock Icons with Labels at 80%, 90%, 100% positions -->
                                <div style="position: absolute; left: 80%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 1rem; opacity: 0.5;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap;">Tier 1<br>Bronze</div>
                                </div>
                                <div style="position: absolute; left: 90%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 1rem; opacity: 0.5;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap;">Tier 2<br>Silver</div>
                                </div>
                                <div style="position: absolute; left: 100%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 1rem; opacity: 0.5;">🔒</div>
                                    <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 4px; white-space: nowrap;">Tier 3<br>Gold</div>
                                </div>
                            </div>
                        </div>
                    `;
                    tierUnlockCache.set(cacheKey, result);
                    return result;
                }
                
                // Calculate tier targets
                const tier1Target = Math.round(monthlyTarget * 0.8); // 80%
                const tier2Target = Math.round(monthlyTarget * 0.9); // 90%
                const tier3Target = monthlyTarget; // 100%
                
                // Determine unlocked tiers
                const tier1Unlocked = currentRevenue >= tier1Target;
                const tier2Unlocked = currentRevenue >= tier2Target;
                const tier3Unlocked = currentRevenue >= tier3Target;
                
                // Calculate overall progress percentage
                const progressPercentage = Math.min((currentRevenue / monthlyTarget) * 100, 100);
                
                const result = `
                    <div class="tier-unlock-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; padding: 12px; margin: 10px 0; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.85rem; font-weight: 600;">🏆 Achievement Progress</span>
                            <span style="font-size: 0.8rem; font-weight: 600;">${progressPercentage.toFixed(1)}%</span>
                        </div>
                        
                        <!-- Progress Bar with Lock Icons and Labels -->
                        <div style="position: relative; background: rgba(255,255,255,0.2); border-radius: 10px; height: 12px; margin-bottom: 25px; overflow: visible;">
                            <div style="background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); height: 100%; width: ${progressPercentage}%; transition: width 0.3s ease; border-radius: 10px;"></div>
                            
                            <!-- Lock Icons with Labels at 80%, 90%, 100% positions -->
                            <div style="position: absolute; left: 80%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 1rem; ${tier1Unlocked ? 'filter: drop-shadow(0 0 3px #CD7F32);' : ''}">${tier1Unlocked ? '🥉' : '🔒'}</div>
                                <div style="font-size: 0.6rem; opacity: ${tier1Unlocked ? '1' : '0.7'}; margin-top: 4px; white-space: nowrap;">Tier 1<br>Bronze</div>
                            </div>
                            <div style="position: absolute; left: 90%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 1rem; ${tier2Unlocked ? 'filter: drop-shadow(0 0 3px #C0C0C0);' : ''}">${tier2Unlocked ? '🥈' : '🔒'}</div>
                                <div style="font-size: 0.6rem; opacity: ${tier2Unlocked ? '1' : '0.7'}; margin-top: 4px; white-space: nowrap;">Tier 2<br>Silver</div>
                            </div>
                            <div style="position: absolute; left: 100%; top: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 1rem; ${tier3Unlocked ? 'filter: drop-shadow(0 0 3px #FFD700);' : ''}">${tier3Unlocked ? '🥇' : '🔒'}</div>
                                <div style="font-size: 0.6rem; opacity: ${tier3Unlocked ? '1' : '0.7'}; margin-top: 4px; white-space: nowrap;">Tier 3<br>Gold</div>
                            </div>
                        </div>
                    </div>
                `;
                
                tierUnlockCache.set(cacheKey, result);
                return result;
            } catch (error) {
                console.error('❌ Error in renderTierUnlockBar:', error);
                const errorResult = `
                    <div class="tier-unlock-bar" style="background: #fed7d7; border: 1px solid #e53e3e; border-radius: 8px; padding: 12px; margin: 10px 0; color: #e53e3e; text-align: center;">
                        <div style="font-size: 0.8rem;">⚠️ Tier system temporarily unavailable</div>
                    </div>
                `;
                tierUnlockCache.set(cacheKey, errorResult);
                return errorResult;
            }
        }

        function saveMedalAchievement(outletCode, tier, rewardAmount) {
            // Get current user medals
            const currentUser = JSON.parse(sessionStorage.getItem('userAuth'));
            const userMedals = JSON.parse(localStorage.getItem('userMedals')) || {};
            
            if (!userMedals[currentUser.username]) {
                userMedals[currentUser.username] = {
                    medals: [],
                    totalRewards: 0
                };
            }
            
            // Check if this tier medal already exists for this month
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
            const existingMedal = userMedals[currentUser.username].medals.find(
                medal => medal.outletCode === outletCode && 
                medal.month === currentMonth && 
                medal.tier >= tier
            );
            
            if (!existingMedal || existingMedal.tier < tier) {
                // Add or upgrade medal
                const medalData = {
                    outletCode: outletCode,
                    tier: tier,
                    month: currentMonth,
                    rewardAmount: rewardAmount,
                    achievedDate: new Date().toISOString(),
                    tierName: tier === 3 ? "Gold" : tier === 2 ? "Silver" : "Bronze"
                };
                
                if (existingMedal) {
                    // Upgrade existing medal
                    const medalIndex = userMedals[currentUser.username].medals.indexOf(existingMedal);
                    userMedals[currentUser.username].medals[medalIndex] = medalData;
                } else {
                    // Add new medal
                    userMedals[currentUser.username].medals.push(medalData);
                }
                
                // Update total rewards
                userMedals[currentUser.username].totalRewards = userMedals[currentUser.username].medals.reduce(
                    (sum, medal) => sum + medal.rewardAmount, 0
                );
                
                // Save to localStorage
                localStorage.setItem('userMedals', JSON.stringify(userMedals));
                
                console.log(`🏆 Medal achieved: ${medalData.tierName} for outlet ${outletCode}`);
            }
        }

        function getUserMedals() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('userAuth') || '{}');
                const userMedals = JSON.parse(localStorage.getItem('userMedals') || '{}');
                
                if (!currentUser.username || !userMedals[currentUser.username]) {
                    return [];
                }
                
                return userMedals[currentUser.username].medals.map(medal => ({
                    ...medal,
                    tierEmoji: medal.tier === 3 ? '🥇' : medal.tier === 2 ? '🥈' : '🥉'
                })).sort((a, b) => b.tier - a.tier || new Date(b.achievedDate) - new Date(a.achievedDate));
            } catch (error) {
                console.error('❌ Error getting user medals:', error);
                return [];
            }
        }



        function renderMedalShowcase() {
            try {
                const userMedals = getUserMedals();
                const currentUser = JSON.parse(sessionStorage.getItem('userAuth') || '{}');
                const userMedalData = JSON.parse(localStorage.getItem('userMedals') || '{}')[currentUser.username];
                const totalRewards = userMedalData?.totalRewards || 0;
            
            const showcaseElement = document.getElementById('medal-showcase');
            
            // Add admin controls for medal rewarding
            const adminMedalControls = userPermissions && userPermissions.canRewardMedals ? `
                <div style="margin-bottom: 15px;">
                    <button onclick="openRewardMedalModal()" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s;"
                            onmouseover="this.style.transform='translateY(-1px)'"
                            onmouseout="this.style.transform='translateY(0)'">
                        🏆 Award Special Medal
                    </button>
                </div>
            ` : '';

            if (userMedals.length === 0) {
                showcaseElement.innerHTML = `
                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; text-align: center;">
                        ${adminMedalControls}
                        <div style="font-size: 2rem; margin-bottom: 10px;">🏆</div>
                        <h3 style="color: #4a5568; margin-bottom: 10px;">Medal Collection</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Complete sales targets to earn medals and rewards!</p>
                        <div style="background: #f7fafc; border-radius: 8px; padding: 12px;">
                            <div style="font-size: 0.9rem; color: #4a5568;">🥉 Tier 1 (80%): 1.35% reward | 🥈 Tier 2 (90%): 2.0% reward | 🥇 Tier 3 (100%): 2.7% reward</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            showcaseElement.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #4a5568; margin: 0;">🏆 Your Medal Collection</h3>
                        <div style="text-align: right;">
                            <div style="color: #48bb78; font-weight: 700; font-size: 1.1rem;">${formatCurrency(totalRewards)}</div>
                            <div style="color: #718096; font-size: 0.8rem;">Total Rewards Earned</div>
                        </div>
                    </div>
                    ${adminMedalControls}
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        ${userMedals.slice(0, 6).map(medal => `
                            <div style="background: linear-gradient(135deg, ${medal.tier === 3 ? '#ffd700, #ffed4a' : medal.tier === 2 ? '#c0c0c0, #e2e8f0' : '#cd7f32, #d69e2e'}); border-radius: 10px; padding: 12px; text-align: center; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                                <div style="font-size: 2rem; margin-bottom: 8px;">${medal.tierEmoji}</div>
                                <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 4px;">${medal.tierName} Medal</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 6px;">Outlet: ${medal.outletCode}</div>
                                <div style="font-size: 0.8rem; font-weight: 600;">${formatCurrency(medal.rewardAmount)}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">${new Date(medal.achievedDate).toLocaleDateString()}</div>
                            </div>
                        `).join('')}
                        
                        ${userMedals.length > 6 ? `
                            <div style="background: #f7fafc; border: 2px dashed #cbd5e0; border-radius: 10px; padding: 12px; text-align: center; display: flex; align-items: center; justify-content: center;">
                                <div style="color: #4a5568; font-size: 0.9rem;">
                                    <div style="font-weight: 600;">+${userMedals.length - 6} more medals</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Keep achieving!</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('❌ Medal showcase rendering failed:', error);
                const showcaseElement = document.getElementById('medal-showcase');
                if (showcaseElement) {
                    showcaseElement.innerHTML = `
                        <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; text-align: center;">
                            <div style="color: #e53e3e; font-size: 0.9rem;">⚠️ Medal showcase temporarily unavailable</div>
                        </div>
                    `;
                }
            }
        }

        function showNotification(message, type = 'success') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => notif.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Add Outlet Modal Functions
        function openAddOutletModal() {
            if (!userPermissions.canAddOutlets) {
                showNotification('❌ You do not have permission to add outlets', 'error');
                return;
            }
            
            const modal = document.getElementById('add-outlet-modal');
            const outletList = document.getElementById('outlet-list');
            
            // Get available outlets (not already in Phoenix)
            const availableOutlets = allOutlets.filter(outlet => 
                !phoenixData.outlets[outlet.code] && 
                userPermissions.allowedOutlets.includes(outlet.code)
            );
            
            outletList.innerHTML = availableOutlets.map(outlet => `
                <div class="outlet-item" onclick="selectOutletForAdd('${outlet.code}')">
                    <div class="outlet-item-name">${outlet.name}</div>
                    <div class="outlet-item-code">Code: ${outlet.code} | AM: ${outlet.am}</div>
                </div>
            `).join('');
            
            if (availableOutlets.length === 0) {
                outletList.innerHTML = '<div style="padding: 20px; text-align: center; color: #718096;">No available outlets to add</div>';
            }
            
            modal.style.display = 'flex';
        }

        function selectOutletForAdd(outletCode) {
            // Remove previous selection
            document.querySelectorAll('.outlet-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current item
            event.target.closest('.outlet-item').classList.add('selected');
            selectedOutletForAdd = outletCode;
            
            // Enable add button
            document.getElementById('add-outlet-confirm-btn').disabled = false;
        }

        function addSelectedOutlet() {
            if (!selectedOutletForAdd) return;
            
            const outlet = allOutlets.find(o => o.code === selectedOutletForAdd);
            if (!outlet) return;
            
            // Add to Phoenix data
            phoenixData.outlets[selectedOutletForAdd] = {
                dateAdded: new Date().toISOString(),
                performanceData: {
                    baseline: { revenue: 0, trano: 0 },
                    term1: { revenue: 0, trano: 0 },
                    term2: { revenue: 0, trano: 0 },
                    term3: { revenue: 0, trano: 0 }
                }
            };
            
            // Save to cross-device storage
            savePhoenixData('OKR data updated');
            
            // Refresh data
            loadPhoenixOutlets();
            renderPhoenixDashboard();
            
            // Close modal
            closeAddOutletModal();
            
            showNotification(`✅ ${outlet.name} added to Phoenix Project!`, 'success');
        }

        function closeAddOutletModal() {
            document.getElementById('add-outlet-modal').style.display = 'none';
            selectedOutletForAdd = null;
            document.getElementById('add-outlet-confirm-btn').disabled = true;
        }

        function filterOutlets() {
            const searchTerm = document.getElementById('outlet-search').value.toLowerCase();
            const outletItems = document.querySelectorAll('.outlet-item');
            
            outletItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // OKR Assignment Functions
        function assignOKR(outletCode) {
            if (!userPermissions.canAssignOKR && !userPermissions.canEditOKR) {
                showNotification('❌ You do not have permission to assign OKRs', 'error');
                return;
            }
            
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet) {
                console.error('❌ Outlet not found:', outletCode);
                showNotification('❌ Outlet not found', 'error');
                return;
            }
            
            currentOKROutlet = outlet;
            console.log('✅ Assigning OKR to outlet:', currentOKROutlet);
            
            const modal = document.getElementById('okr-modal');
            const modalTitle = document.getElementById('okr-modal-title');
            const modalBody = document.getElementById('okr-modal-body');
            
            modalTitle.textContent = `🎯 ${outlet.okr ? 'Edit' : 'Assign'} OKR for ${outlet.name}`;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">Choose Phoenix OKR Template:</h4>
                    ${phoenixOKRTemplates.map(template => `
                        <div class="okr-template-option" data-template-id="${template.id}" onclick="selectOKRTemplate(${template.id})">
                            <div class="okr-template-title">${template.title}</div>
                            <div class="okr-template-desc">${template.description}</div>
                            <div class="okr-template-category">${template.category}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div id="okr-customization" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #2d3748;">📝 Customize OKR</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 5px;">Objective:</label>
                        <input type="text" id="okr-objective-input" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 5px;">Description:</label>
                        <textarea id="okr-description-input" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 5px;">Key Results (one per line):</label>
                        <textarea id="okr-keyresults-input" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; min-height: 100px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeOKRModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveOKRAssignment()" id="save-okr-btn" disabled>Assign OKR</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function selectOKRTemplate(templateId) {
            // Remove previous selection
            document.querySelectorAll('.okr-template-option').forEach(option => {
                option.style.borderColor = '#e2e8f0';
                option.style.background = 'white';
            });
            
            // Select current template
            const selectedOption = document.querySelector(`[data-template-id="${templateId}"]`);
            selectedOption.style.borderColor = '#48bb78';
            selectedOption.style.background = '#f0fff4';
            
            // Get template data
            const template = phoenixOKRTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            // Fill customization form
            document.getElementById('okr-objective-input').value = template.title;
            document.getElementById('okr-description-input').value = template.description;
            document.getElementById('okr-keyresults-input').value = template.keyResults.join('\n');
            
            // Show customization section
            document.getElementById('okr-customization').style.display = 'block';
            document.getElementById('save-okr-btn').disabled = false;
        }

        function saveOKRAssignment() {
            if (!currentOKROutlet) return;
            
            const objective = document.getElementById('okr-objective-input').value.trim();
            const description = document.getElementById('okr-description-input').value.trim();
            const keyResultsText = document.getElementById('okr-keyresults-input').value.trim();
            
            if (!objective || !keyResultsText) {
                showNotification('❌ Please fill in objective and key results', 'error');
                return;
            }
            
            const keyResults = keyResultsText.split('\n').filter(kr => kr.trim()).map(kr => kr.trim());
            
            // Get the selected template to include action plans
            const selectedTemplateId = document.querySelector('.okr-template-option[style*="border-color: rgb(72, 187, 120)"]')?.getAttribute('data-template-id');
            const selectedTemplate = selectedTemplateId ? phoenixOKRTemplates.find(t => t.id == selectedTemplateId) : null;
            
            // Create OKR object
            const okr = {
                objective: objective,
                description: description,
                keyResults: keyResults,
                actionPlans: selectedTemplate ? selectedTemplate.actionPlans : null,
                progress: 0,
                dateAssigned: new Date().toISOString()
            };
            
            // Save to Phoenix data
            if (!phoenixData.outlets[currentOKROutlet.code]) {
                phoenixData.outlets[currentOKROutlet.code] = {};
            }
            phoenixData.outlets[currentOKROutlet.code].okr = okr;
            
            // Update local outlet object
            currentOKROutlet.okr = okr;
            
            // Save to cross-device storage
            savePhoenixData('OKR data updated');
            
            // Update the phoenixOutlets array to reflect the change
            const outletIndex = phoenixOutlets.findIndex(o => o.code === currentOKROutlet.code);
            if (outletIndex >= 0) {
                phoenixOutlets[outletIndex].okr = okr;
                console.log('✅ Updated phoenixOutlets array at index:', outletIndex);
            } else {
                console.error('❌ Could not find outlet in phoenixOutlets array:', currentOKROutlet.code);
            }
            
            // Close modal and refresh
            closeOKRModal();
            
            // Reload Phoenix outlets to ensure data persistence
            loadPhoenixOutlets();
            
            // Refresh both dashboard and detail view if we're in detail view
            renderPhoenixDashboard();
            
            // If we're in detail view, also update the OKR section
            if (document.getElementById('detail-view').style.display === 'block') {
                renderOutletOKRSection(currentOKROutlet);
            }
            
            showNotification(`✅ OKR "${objective}" assigned to ${currentOKROutlet.name}!`, 'success');
            
            console.log('✅ OKR saved successfully:', okr);
            console.log('✅ Updated outlet data:', currentOKROutlet);
        }

        function closeOKRModal() {
            document.getElementById('okr-modal').style.display = 'none';
            currentOKROutlet = null;
        }

        function renderOutletOKRSection(outlet) {
            const okrSection = document.getElementById('outlet-okr-section');
            
            if (outlet.okr) {
                okrSection.innerHTML = `
                    <div style="background: #f0fff4; border: 1px solid #48bb78; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="color: #2d3748; margin-bottom: 8px;">📋 Current Objective</h4>
                                <div style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">${outlet.okr.objective}</div>
                                ${outlet.okr.description ? `<div style="color: #718096; font-size: 0.9rem; margin-bottom: 15px;">${outlet.okr.description}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #48bb78; font-weight: 700; font-size: 1.2rem;">${outlet.okr.progress || 0}%</div>
                                <div style="color: #718096; font-size: 0.8rem;">Progress</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #4a5568; margin-bottom: 15px;">🎯 Key Results & Action Plans (${outlet.okr.keyResults.length})</h5>
                            <div style="display: grid; gap: 20px;">
                                ${outlet.okr.keyResults.map((kr, krIndex) => {
                                    const krKey = `kr${krIndex + 1}`;
                                    const actionPlans = outlet.okr.actionPlans?.[krKey] || [];
                                    const krProgressData = outlet.okr.krProgress?.[krKey] || { completedActions: [], comments: {}, likes: {}, priorities: {}, chatMessages: {} };
                                    const completedActions = krProgressData.completedActions || [];
                                    const comments = krProgressData.comments || {};
                                    const krProgress = actionPlans.length > 0 ? Math.round((completedActions.length / actionPlans.length) * 100) : 0;
                                    
                                    return `
                                        <div style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #48bb78; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                <div style="flex: 1;">
                                                    <div style="font-size: 0.95rem; font-weight: 600; color: #2d3748; margin-bottom: 8px;">${kr}</div>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 10px;">
                                                    <button onclick="editKRActionPlans('${outlet.code}', '${krKey}')" 
                                                            style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" 
                                                            title="Edit action plans">
                                                        ✏️ Edit
                                                    </button>
                                                    <div style="text-align: right;">
                                                        <div style="color: #48bb78; font-weight: 700; font-size: 1rem;">${krProgress}%</div>
                                                        <div style="color: #718096; font-size: 0.75rem;">Progress</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${actionPlans.length > 0 ? `
                                                <div style="margin-top: 12px;">
                                                    <h6 style="color: #4a5568; font-size: 0.85rem; font-weight: 600; margin-bottom: 10px;">📝 Action Plans:</h6>
                                                    <div style="display: grid; gap: 12px;">
                                                        ${actionPlans.map((action, actionIndex) => {
                                                            const isCompleted = completedActions.includes(actionIndex);
                                                            const commentKey = `action_${actionIndex}`;
                                                            const comment = comments[commentKey] || '';
                                                            
                                                            return `
                                                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid ${isCompleted ? '#48bb78' : '#e2e8f0'};">
                                                                    <div style="display: flex; align-items: center; gap: 10px;">
                                                                        <input type="checkbox" id="action_${outlet.code}_${krKey}_${actionIndex}" 
                                                                               ${isCompleted ? 'checked' : ''}
                                                                               onchange="toggleActionPlan('${outlet.code}', '${krKey}', ${actionIndex})"
                                                                               style="cursor: pointer;">
                                                                        <label for="action_${outlet.code}_${krKey}_${actionIndex}" 
                                                                               style="flex: 1; font-size: 0.85rem; color: #4a5568; cursor: pointer; ${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">
                                                                            ${action}
                                                                        </label>
                                                                        
                                                                        <!-- Action Icons -->
                                                                        <div style="display: flex; align-items: center; gap: 8px;">
                                                                            <!-- Priority Selector -->
                                                                            <select id="priority_${outlet.code}_${krKey}_${actionIndex}" 
                                                                                    onchange="updateActionPriority('${outlet.code}', '${krKey}', ${actionIndex}, this.value)"
                                                                                    style="padding: 2px 4px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                                                                <option value="" ${!krProgressData.priorities?.[`action_${actionIndex}`] ? 'selected' : ''}>Priority</option>
                                                                                <option value="high" ${krProgressData.priorities?.[`action_${actionIndex}`] === 'high' ? 'selected' : ''}>🔴 High</option>
                                                                                <option value="medium" ${krProgressData.priorities?.[`action_${actionIndex}`] === 'medium' ? 'selected' : ''}>🟡 Medium</option>
                                                                                <option value="low" ${krProgressData.priorities?.[`action_${actionIndex}`] === 'low' ? 'selected' : ''}>🟢 Low</option>
                                                                            </select>
                                                                            
                                                                            <!-- Like Button -->
                                                                            <button id="like-btn-${outlet.code}-${krKey}-${actionIndex}" 
                                                                                    onclick="toggleActionLike('${outlet.code}', '${krKey}', ${actionIndex}); event.stopPropagation();" 
                                                                                    style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 6px; transition: all 0.2s ease; border-radius: 50%; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center;" 
                                                                                    onmouseover="this.style.background='rgba(72, 187, 120, 0.1)'; this.style.transform='scale(1.1)'" 
                                                                                    onmouseout="this.style.background='none'; this.style.transform='scale(1)'" 
                                                                                    onmousedown="this.style.transform='scale(0.95)'" 
                                                                                    onmouseup="this.style.transform='scale(1.1)'" 
                                                                                    title="Like this action">
                                                                                ${krProgressData.likes?.[`action_${actionIndex}`] ? '❤️' : '🤍'}
                                                                            </button>
                                                                            
                                                                            <!-- Comment Button -->
                                                                            <button onclick="openCommentModal('${outlet.code}', '${krKey}', ${actionIndex})" 
                                                                                    style="background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px; position: relative;" 
                                                                                    title="Add/view comments">
                                                                                💬
                                                                                ${(comment || (krProgressData.chatMessages?.[`action_${actionIndex}`] && krProgressData.chatMessages[`action_${actionIndex}`].length > 0)) ? '<span style="position: absolute; top: -2px; right: -2px; background: #48bb78; color: white; border-radius: 50%; width: 8px; height: 8px; font-size: 0;">.</span>' : ''}
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="assignOKR('${outlet.code}')" style="background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                ✏️ Edit OKR
                            </button>
                            <button onclick="updateOKRProgress('${outlet.code}')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                📊 Update Progress
                            </button>
                        </div>
                    </div>
                `;
            } else {
                okrSection.innerHTML = `
                    <div style="background: #fef5e7; border: 1px solid #d69e2e; border-radius: 10px; padding: 20px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🎯</div>
                        <h4 style="color: #d69e2e; margin-bottom: 10px;">No OKR Assigned</h4>
                        <p style="color: #718096; margin-bottom: 20px;">This outlet doesn't have an OKR assigned yet. Assign one to start tracking objectives and key results.</p>
                        <button onclick="assignOKR('${outlet.code}')" style="background: #48bb78; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                            🎯 Assign OKR Now
                        </button>
                    </div>
                `;
            }
        }

        function toggleActionPlan(outletCode, krKey, actionIndex) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) return;
            
            // Initialize KR progress data if it doesn't exist
            if (!outlet.okr.krProgress) {
                outlet.okr.krProgress = {};
            }
            if (!outlet.okr.krProgress[krKey]) {
                outlet.okr.krProgress[krKey] = { completedActions: [], comments: {}, likes: {}, priorities: {}, chatMessages: {} };
            }
            
            const completedActions = outlet.okr.krProgress[krKey].completedActions;
            const actionIndexInArray = completedActions.indexOf(actionIndex);
            
            // Toggle completion status
            if (actionIndexInArray > -1) {
                // Remove from completed actions
                completedActions.splice(actionIndexInArray, 1);
            } else {
                // Add to completed actions
                completedActions.push(actionIndex);
            }
            
            // Update localStorage
            phoenixData.outlets[outletCode].okr.krProgress = outlet.okr.krProgress;
            localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            
            // Calculate overall OKR progress
            updateOverallOKRProgress(outletCode);
            
            // Refresh views
            renderOutletOKRSection(outlet);
            renderPhoenixDashboard();
            
            console.log(`✅ Toggled action plan ${actionIndex} for ${krKey} in outlet ${outletCode}`);
        }
        
        // Global variables for modals
        let currentCommentOutlet = null;
        let currentCommentKR = null;
        let currentCommentAction = null;
        let currentEditOutlet = null;
        let currentEditKR = null;
        let currentDetailOutlet = null; // Track current outlet in detail view
        
        function openCommentModal(outletCode, krKey, actionIndex) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) return;
            
            currentCommentOutlet = outletCode;
            currentCommentKR = krKey;
            currentCommentAction = actionIndex;
            
            const actionPlans = outlet.okr.actionPlans[krKey] || [];
            const actionText = actionPlans[actionIndex] || '';
            const commentKey = `action_${actionIndex}`;
            const chatMessages = outlet.okr.krProgress?.[krKey]?.chatMessages?.[commentKey] || [];
            
            // Update modal content
            document.getElementById('comment-action-text').textContent = actionText;
            document.getElementById('new-comment-input').value = '';
            
            // Render chat messages
            renderChatMessages(chatMessages);
            
            // Show modal
            document.getElementById('comment-modal').style.display = 'flex';
        }
        
        function renderChatMessages(messages) {
            const chatContainer = document.getElementById('chat-messages');
            
            if (messages.length === 0) {
                chatContainer.innerHTML = '<div style="text-align: center; color: #718096; font-style: italic;">No comments yet. Be the first to comment!</div>';
                return;
            }
            
            chatContainer.innerHTML = messages.map(msg => `
                <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #48bb78;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <div style="font-weight: 600; color: #2d3748; font-size: 0.85rem;">${msg.user}</div>
                        <div style="color: #718096; font-size: 0.75rem;">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                    <div style="color: #4a5568; font-size: 0.9rem; line-height: 1.4;">${msg.message}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function addNewComment() {
            if (!currentCommentOutlet || !currentCommentKR || currentCommentAction === null) return;
            
            const messageInput = document.getElementById('new-comment-input');
            const message = messageInput.value.trim();
            if (!message) return;
            
            const outlet = phoenixOutlets.find(o => o.code === currentCommentOutlet);
            if (!outlet || !outlet.okr) return;
            
            // Initialize KR progress data if it doesn't exist
            if (!outlet.okr.krProgress) {
                outlet.okr.krProgress = {};
            }
            if (!outlet.okr.krProgress[currentCommentKR]) {
                outlet.okr.krProgress[currentCommentKR] = { completedActions: [], comments: {}, likes: {}, priorities: {}, chatMessages: {} };
            }
            
            const commentKey = `action_${currentCommentAction}`;
            if (!outlet.okr.krProgress[currentCommentKR].chatMessages) {
                outlet.okr.krProgress[currentCommentKR].chatMessages = {};
            }
            if (!outlet.okr.krProgress[currentCommentKR].chatMessages[commentKey]) {
                outlet.okr.krProgress[currentCommentKR].chatMessages[commentKey] = [];
            }
            
            // Add new message
            const newMessage = {
                user: currentUser.name || currentUser.username,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            outlet.okr.krProgress[currentCommentKR].chatMessages[commentKey].push(newMessage);
            
            // Update old comment field for backward compatibility (show latest message)
            outlet.okr.krProgress[currentCommentKR].comments[commentKey] = message;
            
            // Update localStorage
            phoenixData.outlets[currentCommentOutlet].okr.krProgress = outlet.okr.krProgress;
            localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            
            // Clear input and refresh chat
            messageInput.value = '';
            renderChatMessages(outlet.okr.krProgress[currentCommentKR].chatMessages[commentKey]);
            
            // Refresh main view to show comment indicator
            renderOutletOKRSection(outlet);
            
            console.log(`✅ Added new comment for action ${currentCommentAction} in ${currentCommentKR} for outlet ${currentCommentOutlet}`);
        }
        
        function closeCommentModal() {
            document.getElementById('comment-modal').style.display = 'none';
            currentCommentOutlet = null;
            currentCommentKR = null;
            currentCommentAction = null;
        }
        
        function toggleActionLike(outletCode, krKey, actionIndex) {
            console.log(`🔄 [LIKE DEBUG] Starting toggle for action ${actionIndex} in ${krKey} for outlet ${outletCode}`);
            
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) {
                console.error('❌ [LIKE DEBUG] Outlet or OKR not found');
                return;
            }
            
            console.log(`🔍 [LIKE DEBUG] Found outlet:`, outlet.code);
            console.log(`🔍 [LIKE DEBUG] Current OKR progress:`, outlet.okr.krProgress);
            console.log(`🔍 [LIKE DEBUG] Parameters - krKey: ${krKey}, actionIndex: ${actionIndex}`);
            
            // Initialize KR progress data if it doesn't exist
            if (!outlet.okr.krProgress) {
                outlet.okr.krProgress = {};
                console.log(`🔧 [LIKE DEBUG] Initialized krProgress`);
            }
            if (!outlet.okr.krProgress[krKey]) {
                outlet.okr.krProgress[krKey] = { completedActions: [], comments: {}, likes: {}, priorities: {}, chatMessages: {} };
                console.log(`🔧 [LIKE DEBUG] Initialized ${krKey} progress`);
            }
            
            // Ensure the likes object exists
            if (!outlet.okr.krProgress[krKey].likes) {
                outlet.okr.krProgress[krKey].likes = {};
                console.log(`🔧 [LIKE DEBUG] Initialized likes object for ${krKey}`);
            }
            
            // Toggle like status
            const likeKey = `action_${actionIndex}`;
            const currentLike = outlet.okr.krProgress[krKey].likes[likeKey] || false;
            const newLikeStatus = !currentLike;
            outlet.okr.krProgress[krKey].likes[likeKey] = newLikeStatus;
            
            console.log(`💝 [LIKE DEBUG] Like key: ${likeKey}`);
            console.log(`💝 [LIKE DEBUG] Previous status: ${currentLike}`);
            console.log(`💝 [LIKE DEBUG] New status: ${newLikeStatus}`);
            console.log(`💝 [LIKE DEBUG] Updated likes object:`, outlet.okr.krProgress[krKey].likes);
            
            // Update phoenixData (localStorage sync)
            if (!phoenixData.outlets[outletCode]) {
                phoenixData.outlets[outletCode] = { okr: outlet.okr };
            }
            if (!phoenixData.outlets[outletCode].okr) {
                phoenixData.outlets[outletCode].okr = outlet.okr;
            }
            phoenixData.outlets[outletCode].okr.krProgress = outlet.okr.krProgress;
            localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            console.log(`💾 [LIKE DEBUG] Data saved to localStorage`);
            
            // Immediate UI update - find and update the specific button
            const buttonId = `like-btn-${outletCode}-${krKey}-${actionIndex}`;
            const likeButton = document.getElementById(buttonId);
            
            console.log(`🎯 [LIKE DEBUG] Looking for button ID: ${buttonId}`);
            console.log(`🎯 [LIKE DEBUG] Button found:`, likeButton ? 'YES' : 'NO');
            
            if (likeButton) {
                const newEmoji = newLikeStatus ? '❤️' : '🤍';
                console.log(`🎨 [LIKE DEBUG] Setting button content to: ${newEmoji}`);
                console.log(`🎨 [LIKE DEBUG] Button current content: ${likeButton.innerHTML}`);
                
                likeButton.innerHTML = newEmoji;
                
                console.log(`🎨 [LIKE DEBUG] Button content after update: ${likeButton.innerHTML}`);
                
                // Add visual feedback with animation
                likeButton.style.transform = 'scale(1.4)';
                likeButton.style.transition = 'all 0.3s ease';
                
                // Reset animation after delay
                setTimeout(() => {
                    likeButton.style.transform = 'scale(1)';
                    console.log(`✨ [LIKE DEBUG] Animation completed`);
                }, 300);
                
            } else {
                console.error(`❌ [LIKE DEBUG] Could not find like button with ID: ${buttonId}`);
                // Let's try to find all like buttons to see what IDs exist
                const allButtons = document.querySelectorAll('button[id*="like-btn"]');
                console.log(`🔍 [LIKE DEBUG] Found ${allButtons.length} like buttons with these IDs:`, 
                    Array.from(allButtons).map(btn => btn.id));
            }
            
            // Show user feedback
            const feedbackMsg = newLikeStatus ? '❤️ Liked!' : '🤍 Unliked!';
            showNotification(feedbackMsg, 'success', 1000);
            
            console.log(`✅ [LIKE DEBUG] Toggle completed successfully`);
        }
        
        function updateActionPriority(outletCode, krKey, actionIndex, priority) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) return;
            
            // Initialize KR progress data if it doesn't exist
            if (!outlet.okr.krProgress) {
                outlet.okr.krProgress = {};
            }
            if (!outlet.okr.krProgress[krKey]) {
                outlet.okr.krProgress[krKey] = { completedActions: [], comments: {}, likes: {}, priorities: {}, chatMessages: {} };
            }
            
            // Update priority
            const priorityKey = `action_${actionIndex}`;
            outlet.okr.krProgress[krKey].priorities[priorityKey] = priority;
            
            // Update localStorage
            phoenixData.outlets[outletCode].okr.krProgress = outlet.okr.krProgress;
            localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            
            console.log(`✅ Updated priority to ${priority} for action ${actionIndex} in ${krKey} for outlet ${outletCode}`);
        }
        
        // Monthly Sales Target Functions for Detail View
        function updateDetailMonthlyTarget() {
            const targetInput = document.getElementById('detail-monthly-target');
            const targetValue = parseFloat(targetInput.value) || 0;
            
            if (targetValue <= 0) {
                showNotification('❌ Please enter a valid target amount', 'error');
                return;
            }
            
            if (!currentDetailOutlet) {
                showNotification('❌ No outlet selected', 'error');
                return;
            }
            
            // Save target to localStorage
            const detailTargetKey = `detail_monthly_target_${currentDetailOutlet}`;
            localStorage.setItem(detailTargetKey, targetValue.toString());
            
            // Also save to main data structure if it exists
            if (phoenixData && phoenixData.outlets && phoenixData.outlets[currentDetailOutlet]) {
                if (!phoenixData.outlets[currentDetailOutlet].salesTargets) {
                    phoenixData.outlets[currentDetailOutlet].salesTargets = {};
                }
                phoenixData.outlets[currentDetailOutlet].salesTargets.monthlyTarget = targetValue;
                localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            }
            
            // Show tier display and calculate progress
            document.getElementById('detail-tier-display').style.display = 'block';
            calculateDetailTierProgress();
            
            showNotification('💾 Monthly target saved successfully!', 'success');
            console.log(`✅ Saved monthly target: Rp ${targetValue.toLocaleString()} for outlet ${currentDetailOutlet}`);
        }
        
        function calculateDetailTierProgress() {
            const targetInput = document.getElementById('detail-monthly-target');
            const targetValue = parseFloat(targetInput.value) || 0;
            
            if (targetValue <= 0) {
                // Hide tier display if no valid target
                document.getElementById('detail-tier-display').style.display = 'none';
                return;
            }
            
            // Calculate tier amounts (80%, 90%, 100%)
            const tier1Amount = Math.round(targetValue * 0.8); // Bronze - 80%
            const tier2Amount = Math.round(targetValue * 0.9); // Silver - 90% 
            const tier3Amount = Math.round(targetValue); // Gold - 100%
            
            // Update tier amount displays
            document.getElementById('detail-tier1-amount').textContent = `Rp ${tier1Amount.toLocaleString()}`;
            document.getElementById('detail-tier2-amount').textContent = `Rp ${tier2Amount.toLocaleString()}`;
            document.getElementById('detail-tier3-amount').textContent = `Rp ${tier3Amount.toLocaleString()}`;
            
            // Get current sales (mock data for now - in real implementation would come from API)
            const currentSales = getCurrentSalesForDetailOutlet();
            
            // Calculate achievement percentage
            const achievementPercentage = targetValue > 0 ? Math.min((currentSales / targetValue) * 100, 100) : 0;
            
            // Determine current tier and medal
            let currentTier = 'Not Qualified';
            let currentMedal = '⚪';
            let rewardPercentage = 0;
            let tierClass = '';
            
            if (currentSales >= tier3Amount) {
                currentTier = 'Tier 3 - Gold';
                currentMedal = '🥇';
                rewardPercentage = 2.7;
                tierClass = 'gold';
            } else if (currentSales >= tier2Amount) {
                currentTier = 'Tier 2 - Silver';
                currentMedal = '🥈';
                rewardPercentage = 2.0;
                tierClass = 'silver';
            } else if (currentSales >= tier1Amount) {
                currentTier = 'Tier 1 - Bronze';
                currentMedal = '🥉';
                rewardPercentage = 1.35;
                tierClass = 'bronze';
            }
            
            // Update UI elements
            document.getElementById('detail-tier-name').textContent = currentTier;
            document.getElementById('detail-achievement-percentage').textContent = `${achievementPercentage.toFixed(1)}%`;
            document.getElementById('detail-progress-bar').style.width = `${achievementPercentage}%`;
            document.getElementById('detail-tier-medal').textContent = currentMedal;
            
            // Update tier highlighting
            document.getElementById('detail-tier1').style.borderColor = currentSales >= tier1Amount ? '#CD7F32' : 'rgba(255,255,255,0.3)';
            document.getElementById('detail-tier2').style.borderColor = currentSales >= tier2Amount ? '#C0C0C0' : 'rgba(255,255,255,0.3)';
            document.getElementById('detail-tier3').style.borderColor = currentSales >= tier3Amount ? '#FFD700' : 'rgba(255,255,255,0.3)';
            
            // Update lock icons on progress bar
            const tier1Lock = document.getElementById('detail-tier1-lock');
            const tier2Lock = document.getElementById('detail-tier2-lock');
            const tier3Lock = document.getElementById('detail-tier3-lock');
            
            if (tier1Lock) tier1Lock.textContent = currentSales >= tier1Amount ? '🥉' : '🔒';
            if (tier2Lock) tier2Lock.textContent = currentSales >= tier2Amount ? '🥈' : '🔒';
            if (tier3Lock) tier3Lock.textContent = currentSales >= tier3Amount ? '🥇' : '🔒';
            
            // Calculate and display reward
            const rewardAmount = Math.round(currentSales * (rewardPercentage / 100));
            document.getElementById('detail-reward-amount').textContent = `Rp ${rewardAmount.toLocaleString()}`;
            document.getElementById('detail-reward-percentage').textContent = `(${rewardPercentage}% of revenue)`;
            
            // Show/hide reward display
            if (rewardPercentage > 0) {
                document.getElementById('detail-reward-display').style.display = 'block';
            } else {
                document.getElementById('detail-reward-display').style.display = 'none';
            }
            
            // Update motivation text
            let motivationText = '';
            if (currentSales >= tier3Amount) {
                motivationText = '🎉 Excellent! You\'ve achieved Gold tier! Keep up the outstanding performance!';
            } else if (currentSales >= tier2Amount) {
                const needed = tier3Amount - currentSales;
                motivationText = `🥈 Great job on Silver tier! Only Rp ${needed.toLocaleString()} more to reach Gold!`;
            } else if (currentSales >= tier1Amount) {
                const needed = tier2Amount - currentSales;
                motivationText = `🥉 Good work on Bronze tier! Rp ${needed.toLocaleString()} more to reach Silver!`;
            } else {
                const needed = tier1Amount - currentSales;
                motivationText = `📈 You need Rp ${needed.toLocaleString()} more to reach Bronze tier. Keep pushing!`;
            }
            
            document.getElementById('detail-motivation-text').textContent = motivationText;
            
            // Save medal achievement
            saveMedalAchievement(currentDetailOutlet, currentMedal, rewardAmount);
            
            console.log(`📊 Detail tier calculation: ${achievementPercentage.toFixed(1)}% achievement, ${currentTier}, reward: Rp ${rewardAmount.toLocaleString()}`);
        }
        
        function getCurrentSalesForDetailOutlet() {
            if (!currentDetailOutlet) return 0;
            
            // Get actual Term data from the input fields in detail view
            const term1Revenue = parseFloat(document.getElementById('input-term1-revenue')?.value) || 0;
            const term2Revenue = parseFloat(document.getElementById('input-term2-revenue')?.value) || 0;
            const term3Revenue = parseFloat(document.getElementById('input-term3-revenue')?.value) || 0;
            
            // Calculate total based on which terms have data
            let totalRevenue = 0;
            
            if (term3Revenue > 0) {
                // If Term 3 has data, use all three terms
                totalRevenue = term1Revenue + term2Revenue + term3Revenue;
                console.log(`📊 Using all 3 terms: Term1(${term1Revenue.toLocaleString()}) + Term2(${term2Revenue.toLocaleString()}) + Term3(${term3Revenue.toLocaleString()}) = ${totalRevenue.toLocaleString()}`);
            } else if (term2Revenue > 0) {
                // If Term 2 has data but Term 3 doesn't, use Term 1 + Term 2
                totalRevenue = term1Revenue + term2Revenue;
                console.log(`📊 Using 2 terms: Term1(${term1Revenue.toLocaleString()}) + Term2(${term2Revenue.toLocaleString()}) = ${totalRevenue.toLocaleString()}`);
            } else if (term1Revenue > 0) {
                // If only Term 1 has data, use Term 1 only
                totalRevenue = term1Revenue;
                console.log(`📊 Using 1 term: Term1(${term1Revenue.toLocaleString()}) = ${totalRevenue.toLocaleString()}`);
            } else {
                // No term data available
                totalRevenue = 0;
                console.log(`📊 No term data available for outlet ${currentDetailOutlet}`);
            }
            
            return totalRevenue;
        }
        
        function saveMedalAchievement(outletCode, medal, rewardAmount) {
            if (!outletCode || medal === '⚪') return;
            
            // Get existing medals
            const medalsKey = 'phoenixMedals';
            let medals = {};
            try {
                medals = JSON.parse(localStorage.getItem(medalsKey) || '{}');
            } catch (e) {
                medals = {};
            }
            
            // Initialize outlet medals if not exists
            if (!medals[outletCode]) {
                medals[outletCode] = {
                    achievements: [],
                    totalRewards: 0,
                    currentMedal: '⚪'
                };
            }
            
            // Update current medal and total rewards
            medals[outletCode].currentMedal = medal;
            medals[outletCode].totalRewards = (medals[outletCode].totalRewards || 0) + rewardAmount;
            
            // Add achievement if medal changed
            const lastAchievement = medals[outletCode].achievements[medals[outletCode].achievements.length - 1];
            if (!lastAchievement || lastAchievement.medal !== medal) {
                medals[outletCode].achievements.push({
                    medal: medal,
                    reward: rewardAmount,
                    timestamp: new Date().toISOString(),
                    month: new Date().toISOString().substring(0, 7) // YYYY-MM format
                });
            }
            
            // Save back to localStorage
            localStorage.setItem(medalsKey, JSON.stringify(medals));
            
            console.log(`🏆 Medal achievement saved: ${outletCode} earned ${medal} with reward Rp ${rewardAmount.toLocaleString()}`);
        }
        
        function initializeDetailMonthlyTarget(outletCode) {
            // Load existing target from localStorage
            const detailTargetKey = `detail_monthly_target_${outletCode}`;
            const existingTarget = localStorage.getItem(detailTargetKey);
            
            // Also check main data structure
            let savedTarget = 0;
            if (existingTarget) {
                savedTarget = parseFloat(existingTarget);
            } else if (phoenixData && phoenixData.outlets && phoenixData.outlets[outletCode] && phoenixData.outlets[outletCode].salesTargets) {
                savedTarget = phoenixData.outlets[outletCode].salesTargets.monthlyTarget || 0;
            }
            
            // Set the input field
            const targetInput = document.getElementById('detail-monthly-target');
            if (targetInput) {
                targetInput.value = savedTarget > 0 ? savedTarget : '';
                
                // If there's a saved target, show the tier display and calculate progress
                if (savedTarget > 0) {
                    document.getElementById('detail-tier-display').style.display = 'block';
                    calculateDetailTierProgress();
                } else {
                    document.getElementById('detail-tier-display').style.display = 'none';
                }
            }
            
            console.log(`🎯 Initialized detail monthly target for ${outletCode}: Rp ${savedTarget.toLocaleString()}`);
        }
        
        function editKRActionPlans(outletCode, krKey) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) return;
            
            currentEditOutlet = outletCode;
            currentEditKR = krKey;
            
            const krIndex = parseInt(krKey.replace('kr', '')) - 1;
            const krText = outlet.okr.keyResults[krIndex] || '';
            const actionPlans = outlet.okr.actionPlans[krKey] || [];
            
            // Update modal content
            document.getElementById('kr-edit-text').textContent = krText;
            
            // Render editable action plans
            renderEditableActionPlans(actionPlans);
            
            // Show modal
            document.getElementById('kr-edit-modal').style.display = 'flex';
        }
        
        function renderEditableActionPlans(actionPlans) {
            const container = document.getElementById('action-plans-editor');
            
            container.innerHTML = actionPlans.map((action, index) => `
                <div class="action-plan-item" data-index="${index}" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div style="cursor: grab; color: #718096;" title="Drag to reorder">☰</div>
                    <textarea class="action-text-edit" 
                              style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.85rem; min-height: 40px; resize: vertical; font-family: inherit;">${action}</textarea>
                    <button onclick="removeActionPlan(${index})" 
                            style="background: #e53e3e; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" 
                            title="Remove action plan">
                        ✖
                    </button>
                </div>
            `).join('');
            
            // Add drag and drop functionality
            makeSortable(container);
        }
        
        function makeSortable(container) {
            let draggedElement = null;
            
            container.addEventListener('dragstart', (e) => {
                if (e.target.closest('.action-plan-item')) {
                    draggedElement = e.target.closest('.action-plan-item');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });
            
            container.addEventListener('dragend', () => {
                draggedElement = null;
            });
            
            // Make items draggable
            container.querySelectorAll('.action-plan-item').forEach(item => {
                item.setAttribute('draggable', true);
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.action-plan-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function addNewActionPlan() {
            const container = document.getElementById('action-plans-editor');
            const existingItems = container.querySelectorAll('.action-plan-item');
            const newIndex = existingItems.length;
            
            const newItem = document.createElement('div');
            newItem.className = 'action-plan-item';
            newItem.setAttribute('data-index', newIndex);
            newItem.setAttribute('draggable', true);
            newItem.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;';
            
            newItem.innerHTML = `
                <div style="cursor: grab; color: #718096;" title="Drag to reorder">☰</div>
                <textarea class="action-text-edit" 
                          style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.85rem; min-height: 40px; resize: vertical; font-family: inherit;" 
                          placeholder="Enter new action plan..."></textarea>
                <button onclick="removeActionPlan(${newIndex})" 
                        style="background: #e53e3e; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" 
                        title="Remove action plan">
                    ✖
                </button>
            `;
            
            container.appendChild(newItem);
            
            // Focus on the new textarea
            newItem.querySelector('.action-text-edit').focus();
        }
        
        function removeActionPlan(index) {
            const container = document.getElementById('action-plans-editor');
            const items = container.querySelectorAll('.action-plan-item');
            if (items[index]) {
                items[index].remove();
            }
        }
        
        function saveKREdit() {
            if (!currentEditOutlet || !currentEditKR) return;
            
            const outlet = phoenixOutlets.find(o => o.code === currentEditOutlet);
            if (!outlet || !outlet.okr) return;
            
            // Get updated action plans from the editor
            const container = document.getElementById('action-plans-editor');
            const actionItems = container.querySelectorAll('.action-plan-item');
            const updatedActionPlans = [];
            
            actionItems.forEach(item => {
                const text = item.querySelector('.action-text-edit').value.trim();
                if (text) {
                    updatedActionPlans.push(text);
                }
            });
            
            // Update the outlet's action plans
            outlet.okr.actionPlans[currentEditKR] = updatedActionPlans;
            
            // Update localStorage
            phoenixData.outlets[currentEditOutlet].okr.actionPlans = outlet.okr.actionPlans;
            localStorage.setItem('phoenixProjectData', JSON.stringify(phoenixData));
            
            // Update phoenixOutlets array
            const outletIndex = phoenixOutlets.findIndex(o => o.code === currentEditOutlet);
            if (outletIndex >= 0) {
                phoenixOutlets[outletIndex].okr.actionPlans = outlet.okr.actionPlans;
            }
            
            // Close modal and refresh view
            closeKREditModal();
            renderOutletOKRSection(outlet);
            renderPhoenixDashboard();
            
            showNotification('✅ Action plans updated successfully!', 'success');
            console.log(`✅ Updated action plans for ${currentEditKR} in outlet ${currentEditOutlet}`);
        }
        
        function closeKREditModal() {
            document.getElementById('kr-edit-modal').style.display = 'none';
            currentEditOutlet = null;
            currentEditKR = null;
        }
        
        function updateOverallOKRProgress(outletCode) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet || !outlet.okr) return;
            
            const krProgressData = outlet.okr.krProgress || {};
            let totalActions = 0;
            let completedActions = 0;
            
            // Count total and completed actions across all KRs
            ['kr1', 'kr2', 'kr3', 'kr4', 'kr5'].forEach(krKey => {
                const actionPlans = outlet.okr.actionPlans?.[krKey] || [];
                const completed = krProgressData[krKey]?.completedActions || [];
                totalActions += actionPlans.length;
                completedActions += completed.length;
            });
            
            // Calculate overall progress
            const overallProgress = totalActions > 0 ? Math.round((completedActions / totalActions) * 100) : 0;
            
            // Update OKR progress
            outlet.okr.progress = overallProgress;
            phoenixData.outlets[outletCode].okr.progress = overallProgress;
            
            console.log(`✅ Updated overall OKR progress to ${overallProgress}% for outlet ${outletCode}`);
        }
        
        function updateOKRProgress(outletCode) {
            const progress = prompt('Enter OKR progress percentage (0-100):');
            if (progress === null) return;
            
            const progressNum = parseInt(progress);
            if (isNaN(progressNum) || progressNum < 0 || progressNum > 100) {
                showNotification('❌ Please enter a valid percentage (0-100)', 'error');
                return;
            }
            
            // Update progress
            if (phoenixData.outlets[outletCode] && phoenixData.outlets[outletCode].okr) {
                phoenixData.outlets[outletCode].okr.progress = progressNum;
                
                // Update local data
                const outlet = phoenixOutlets.find(o => o.code === outletCode);
                if (outlet && outlet.okr) {
                    outlet.okr.progress = progressNum;
                }
                
                // Save to cross-device storage
                savePhoenixData('Performance data updated');
                
                // Refresh views
                renderOutletOKRSection(outlet);
                renderPhoenixDashboard();
                
                showNotification(`✅ OKR progress updated to ${progressNum}%`, 'success');
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            const addModal = document.getElementById('add-outlet-modal');
            const okrModal = document.getElementById('okr-modal');
            const commentModal = document.getElementById('comment-modal');
            const krEditModal = document.getElementById('kr-edit-modal');
            
            if (e.target === addModal) {
                closeAddOutletModal();
            }
            if (e.target === okrModal) {
                closeOKRModal();
            }
            if (e.target === commentModal) {
                closeCommentModal();
            }
            if (e.target === krEditModal) {
                closeKREditModal();
            }
        });

        function saveOutletDetailData() {
            // Get the current outlet from detail view
            const outletCode = document.getElementById('detail-outlet-name').getAttribute('data-outlet-code');
            if (!outletCode) {
                showNotification('❌ No outlet selected', 'error');
                return;
            }
            
            // Get all input values
            const data = {
                baseline: {
                    revenue: parseFloat(document.getElementById('input-baseline-revenue').value) || 0,
                    trano: parseFloat(document.getElementById('input-baseline-trano').value) || 0
                },
                term1: {
                    revenue: parseFloat(document.getElementById('input-term1-revenue').value) || 0,
                    trano: parseFloat(document.getElementById('input-term1-trano').value) || 0
                },
                term2: {
                    revenue: parseFloat(document.getElementById('input-term2-revenue').value) || 0,
                    trano: parseFloat(document.getElementById('input-term2-trano').value) || 0
                },
                term3: {
                    revenue: parseFloat(document.getElementById('input-term3-revenue').value) || 0,
                    trano: parseFloat(document.getElementById('input-term3-trano').value) || 0
                }
            };
            
            // Initialize outlet data if it doesn't exist
            if (!phoenixData.outlets[outletCode]) {
                phoenixData.outlets[outletCode] = {};
            }
            
            // Save performance data
            phoenixData.outlets[outletCode].performanceData = data;
            phoenixData.outlets[outletCode].lastUpdated = new Date().toISOString();
            
            // Update local outlet object
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (outlet) {
                outlet.performanceData = data;
                outlet.lastUpdated = new Date().toISOString();
            }
            
            // Save to cross-device storage
            savePhoenixData('OKR data updated');
            
            // Reload outlets to ensure data persistence
            loadPhoenixOutlets();
            
            // Calculate and update progress tracking
            calculateProportionalProgress(data);
            
            // Refresh dashboard to show updated data
            renderPhoenixDashboard();
            
            // Show success notification
            showNotification('✅ Performance data saved successfully!', 'success');
            
            console.log('✅ Saved performance data for outlet:', outletCode, data);
        }
        
        function calculateProportionalProgress(data) {
            // Calculate proportional baseline values
            const dailyBaselineRevenue = data.baseline.revenue / 30; // Assuming 30-day month
            const dailyBaselineTrano = data.baseline.trano / 30;
            
            // Calculate expected baseline for each term period
            const term1BaselineRevenue = dailyBaselineRevenue * 10; // 10 days
            const term1BaselineTrano = dailyBaselineTrano * 10;
            
            const term2BaselineRevenue = dailyBaselineRevenue * 20; // 20 days
            const term2BaselineTrano = dailyBaselineTrano * 20;
            
            const term3BaselineRevenue = data.baseline.revenue; // Full month
            const term3BaselineTrano = data.baseline.trano;
            
            // Calculate progress percentages
            let term1Progress = '-';
            let term2Progress = '-';
            let term3Progress = '-';
            
            // Term 1 progress (Term 1 vs 10-day baseline)
            if (term1BaselineRevenue > 0 && term1BaselineTrano > 0) {
                const term1RevenueProgress = (data.term1.revenue / term1BaselineRevenue) * 100;
                const term1TranoProgress = (data.term1.trano / term1BaselineTrano) * 100;
                term1Progress = `${Math.round((term1RevenueProgress + term1TranoProgress) / 2)}%`;
            }
            
            // Term 2 progress (Term 1+2 vs 20-day baseline)
            if (term2BaselineRevenue > 0 && term2BaselineTrano > 0) {
                const combinedTerm12Revenue = data.term1.revenue + data.term2.revenue;
                const combinedTerm12Trano = data.term1.trano + data.term2.trano;
                const term2RevenueProgress = (combinedTerm12Revenue / term2BaselineRevenue) * 100;
                const term2TranoProgress = (combinedTerm12Trano / term2BaselineTrano) * 100;
                term2Progress = `${Math.round((term2RevenueProgress + term2TranoProgress) / 2)}%`;
            }
            
            // Term 3 progress (Full month vs baseline)
            if (term3BaselineRevenue > 0 && term3BaselineTrano > 0) {
                const fullMonthRevenue = data.term1.revenue + data.term2.revenue + data.term3.revenue;
                const fullMonthTrano = data.term1.trano + data.term2.trano + data.term3.trano;
                const term3RevenueProgress = (fullMonthRevenue / term3BaselineRevenue) * 100;
                const term3TranoProgress = (fullMonthTrano / term3BaselineTrano) * 100;
                term3Progress = `${Math.round((term3RevenueProgress + term3TranoProgress) / 2)}%`;
            }
            
            // Update progress display
            document.querySelector('#term1-progress .progress-value').textContent = term1Progress;
            document.querySelector('#term2-progress .progress-value').textContent = term2Progress;
            document.querySelector('#term3-progress .progress-value').textContent = term3Progress;
            
            // Update progress indicator colors based on performance
            updateProgressIndicatorColors('#term1-progress', term1Progress);
            updateProgressIndicatorColors('#term2-progress', term2Progress);
            updateProgressIndicatorColors('#term3-progress', term3Progress);
        }
        
        function updateProgressIndicatorColors(selector, progress) {
            const element = document.querySelector(selector);
            const valueElement = element.querySelector('.progress-value');
            
            if (progress === '-') {
                valueElement.style.color = '#718096';
                return;
            }
            
            const progressNum = parseInt(progress.replace('%', ''));
            
            if (progressNum >= 100) {
                valueElement.style.color = '#48bb78'; // Green for 100%+
            } else if (progressNum >= 80) {
                valueElement.style.color = '#38a169'; // Dark green for 80-99%
            } else if (progressNum >= 60) {
                valueElement.style.color = '#d69e2e'; // Yellow for 60-79%
            } else {
                valueElement.style.color = '#e53e3e'; // Red for <60%
            }
        }
        
        function showOutletDetail(outletCode) {
            const outlet = phoenixOutlets.find(o => o.code === outletCode);
            if (!outlet) return;
            
            currentDetailOutlet = outletCode; // Store outlet code for detail view functions
            
            // Hide card view, show detail view
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            
            // Store outlet code for data saving
            document.getElementById('detail-outlet-name').setAttribute('data-outlet-code', outletCode);
            
            // Update header information
            document.getElementById('detail-outlet-name').textContent = outlet.name;
            document.getElementById('detail-outlet-info').textContent = `Code: ${outlet.code} • AM: ${outlet.am}`;
            
            // Load existing performance data if available
            const performanceData = outlet.performanceData || {
                baseline: { revenue: 0, trano: 0 },
                term1: { revenue: 0, trano: 0 },
                term2: { revenue: 0, trano: 0 },
                term3: { revenue: 0, trano: 0 }
            };
            
            // Populate input fields with existing data
            document.getElementById('input-baseline-revenue').value = performanceData.baseline.revenue || '';
            document.getElementById('input-baseline-trano').value = performanceData.baseline.trano || '';
            document.getElementById('input-term1-revenue').value = performanceData.term1.revenue || '';
            document.getElementById('input-term1-trano').value = performanceData.term1.trano || '';
            document.getElementById('input-term2-revenue').value = performanceData.term2.revenue || '';
            document.getElementById('input-term2-trano').value = performanceData.term2.trano || '';
            document.getElementById('input-term3-revenue').value = performanceData.term3.revenue || '';
            document.getElementById('input-term3-trano').value = performanceData.term3.trano || '';
            
            // Calculate initial progress
            calculateProportionalProgress(performanceData);
            
            // Initialize monthly target section
            initializeDetailMonthlyTarget(outletCode);
            
            // Render OKR section
            renderOutletOKRSection(outlet);
        }
        
        function backToCardView() {
            // Hide detail view and show dashboard view
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            
            // Clear current detail outlet
            currentDetailOutlet = null;
            
            // Refresh the dashboard to show any updated data
            renderPhoenixDashboard();
        }
        
        // Add event listeners for real-time progress calculation
        document.addEventListener('DOMContentLoaded', function() {
            // Add input event listeners for real-time progress updates
            const inputIds = [
                'input-baseline-revenue', 'input-baseline-trano',
                'input-term1-revenue', 'input-term1-trano',
                'input-term2-revenue', 'input-term2-trano',
                'input-term3-revenue', 'input-term3-trano'
            ];
            
            inputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        // Get current data from inputs
                        const data = {
                            baseline: {
                                revenue: parseFloat(document.getElementById('input-baseline-revenue').value) || 0,
                                trano: parseFloat(document.getElementById('input-baseline-trano').value) || 0
                            },
                            term1: {
                                revenue: parseFloat(document.getElementById('input-term1-revenue').value) || 0,
                                trano: parseFloat(document.getElementById('input-term1-trano').value) || 0
                            },
                            term2: {
                                revenue: parseFloat(document.getElementById('input-term2-revenue').value) || 0,
                                trano: parseFloat(document.getElementById('input-term2-trano').value) || 0
                            },
                            term3: {
                                revenue: parseFloat(document.getElementById('input-term3-revenue').value) || 0,
                                trano: parseFloat(document.getElementById('input-term3-trano').value) || 0
                            }
                        };
                        
                        // Update progress in real-time
                        calculateProportionalProgress(data);
                        
                        // Also update tier progress if monthly target is set and we're in detail view
                        if (currentDetailOutlet && document.getElementById('detail-tier-display').style.display !== 'none') {
                            calculateDetailTierProgress();
                        }
                    });
                }
            });
        });

        // Cross-device data management utilities with GitHub
        window.exportPhoenixDataToGitHub = async function() {
            try {
                if (typeof GitHubAPI !== 'undefined') {
                    const gitHubAPI = new GitHubAPI();
                    const success = await gitHubAPI.savePhoenixData(phoenixData);
                    
                    if (success) {
                        console.log('✅ Phoenix data exported to GitHub successfully');
                        showNotification('✅ Phoenix data synced to GitHub! Available on all devices.', 'success');
                    } else {
                        console.error('❌ Failed to export to GitHub');
                        showNotification('❌ Failed to sync data to GitHub', 'error');
                    }
                } else {
                    console.error('❌ GitHubAPI not available');
                    showNotification('❌ GitHub API not available', 'error');
                }
            } catch (error) {
                console.error('❌ GitHub export failed:', error);
                showNotification('❌ Failed to export Phoenix data to GitHub', 'error');
            }
        };

        window.exportPhoenixDataAsJSON = function() {
            try {
                if (typeof GitHubAPI !== 'undefined') {
                    const gitHubAPI = new GitHubAPI();
                    gitHubAPI.exportPhoenixData(phoenixData);
                    
                    console.log('📤 Phoenix data exported as JSON file');
                    showNotification('✅ Phoenix data downloaded as JSON file', 'success');
                } else {
                    // Fallback manual export
                    const content = JSON.stringify(phoenixData, null, 2);
                    const blob = new Blob([content], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `phoenix-data-export-${new Date().toISOString().substring(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    console.log('📤 Phoenix data exported as JSON (manual fallback)');
                    showNotification('✅ Phoenix data downloaded as JSON file', 'success');
                }
            } catch (error) {
                console.error('❌ Export failed:', error);
                showNotification('❌ Failed to export Phoenix data', 'error');
            }
        };

        window.importPhoenixDataFromGitHub = async function() {
            try {
                console.log('📥 Importing Phoenix data from GitHub...');
                await loadPhoenixDataFromGitHub();
                
                // Reload outlets and refresh dashboard
                loadPhoenixOutlets();
                renderPhoenixDashboard();
                
                showNotification('✅ Phoenix data imported successfully from GitHub!', 'success');
            } catch (error) {
                console.error('❌ Import failed:', error);
                showNotification('❌ Failed to import Phoenix data from GitHub', 'error');
            }
        };

        window.showGitHubDataHistory = async function() {
            try {
                if (typeof GitHubAPI !== 'undefined') {
                    const gitHubAPI = new GitHubAPI();
                    const history = await gitHubAPI.getDataHistory();
                    
                    if (history.length > 0) {
                        console.log('📚 Phoenix Data Version History:');
                        history.forEach((commit, index) => {
                            console.log(`${index + 1}. ${commit.message} (${commit.date}) by ${commit.author}`);
                        });
                        
                        const historyText = history.map((commit, index) => 
                            `${index + 1}. ${commit.message}\n   Date: ${new Date(commit.date).toLocaleString()}\n   Author: ${commit.author}`
                        ).join('\n\n');
                        
                        alert(`📚 Phoenix Data Version History:\n\n${historyText}`);
                    } else {
                        alert('📚 No version history found');
                    }
                } else {
                    alert('❌ GitHub API not available');
                }
            } catch (error) {
                console.error('❌ Failed to get history:', error);
                alert('❌ Failed to get version history');
            }
        };

        window.showDataSyncInfo = async function() {
            const totalOutlets = Object.keys(phoenixData.outlets).length;
            const localBackup = localStorage.getItem('phoenixProjectDataBackup');
            
            let rateLimit = '';
            try {
                if (typeof GitHubAPI !== 'undefined') {
                    const gitHubAPI = new GitHubAPI();
                    const rate = await gitHubAPI.checkRateLimit();
                    if (rate) {
                        rateLimit = `\n🔄 GitHub API: ${rate.remaining}/${rate.limit} requests remaining`;
                    }
                }
            } catch (error) {
                rateLimit = '\n⚠️ GitHub API: Status unknown';
            }
            
            alert(`📊 Phoenix Data Sync Status:

✅ Local Storage: ${totalOutlets} outlets
${localBackup ? '✅ Local Backup: Available' : '⚠️ Local Backup: Not found'}
🐙 GitHub Storage: Enabled${rateLimit}

🔧 Available Functions:
• exportPhoenixDataToGitHub() - Sync current data to GitHub
• importPhoenixDataFromGitHub() - Import fresh data from GitHub
• exportPhoenixDataAsJSON() - Download data as JSON file
• showGitHubDataHistory() - View version history
• showDataSyncInfo() - Show this status

🚀 GitHub Advantages:
✅ Automatic cross-device sync
✅ Complete version history  
✅ Enterprise-grade reliability
✅ Built-in access control
✅ No additional API keys needed`);
        };

        // Utility function to preserve Phoenix data during logout
        function preservePhoenixDataOnLogout() {
            const dataKeys = ['phoenixProjectData', 'userMedals', 'outletPerformanceData'];
            const preservedData = {};
            
            // Save all Phoenix-related data
            dataKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    preservedData[key] = data;
                    console.log(`📦 Preserving ${key}: ${data.length} characters`);
                }
            });
            
            return preservedData;
        }
        
        // Utility function to restore Phoenix data after logout
        function restorePhoenixDataAfterLogout(preservedData) {
            Object.keys(preservedData).forEach(key => {
                localStorage.setItem(key, preservedData[key]);
                console.log(`✅ Restored ${key}: ${preservedData[key].length} characters`);
            });
        }

        function logout() {
            console.log('🔄 Starting logout process...');
            
            // Step 1: Preserve Phoenix data before clearing localStorage
            const preservedPhoenixData = preservePhoenixDataOnLogout();
            
            console.log('🔄 Preserved Phoenix data summary:', {
                phoenixProjectData: !!preservedPhoenixData.phoenixProjectData,
                userMedals: !!preservedPhoenixData.userMedals,
                outletPerformanceData: !!preservedPhoenixData.outletPerformanceData,
                totalKeys: Object.keys(preservedPhoenixData).length
            });
            
            // Step 2: Clear all authentication and session data
            sessionStorage.clear();
            localStorage.clear();
            console.log('🧹 Cleared all sessionStorage and localStorage data');
            
            // Step 3: Restore Phoenix project data after clearing
            restorePhoenixDataAfterLogout(preservedPhoenixData);
            
            // Step 4: Verify restoration
            const phoenixDataCheck = localStorage.getItem('phoenixProjectData');
            if (phoenixDataCheck && preservedPhoenixData.phoenixProjectData) {
                console.log('✅ Phoenix data restoration verified - data persisted through logout');
            } else if (preservedPhoenixData.phoenixProjectData) {
                console.error('❌ Phoenix data restoration FAILED - data lost during logout');
            } else {
                console.log('ℹ️ No Phoenix data to preserve (user had no Phoenix outlets)');
            }
            
            // Step 5: Redirect to login
            console.log('🚪 Redirecting to login page...');
            window.location.href = 'okr-login.html';
        }

        // Debug Panel Functions
        function toggleDebugPanel() {
            const debugPanel = document.getElementById('debug-panel');
            const isVisible = debugPanel.style.display !== 'none';
            debugPanel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                refreshDebugInfo();
            }
        }

        function refreshDebugInfo() {
            try {
                // User & Permissions Info
                const userInfo = document.getElementById('debug-user-info');
                userInfo.innerHTML = `
                    <strong>Current User:</strong><br>
                    • Name: ${currentUser?.name || currentUser?.username || 'Not set'}<br>
                    • Type: ${currentUser?.type || 'Unknown'}<br>
                    • Role: ${currentUser?.role || 'Unknown'}<br>
                    • Username: ${currentUser?.username || 'Not set'}<br><br>
                    
                    <strong>Permissions:</strong><br>
                    • View All Outlets: ${userPermissions?.canViewAllOutlets || 'false'}<br>
                    • Allowed Outlets: ${userPermissions?.allowedOutlets?.length || 0} outlets<br>
                    • Allowed List: [${userPermissions?.allowedOutlets?.slice(0, 5).join(', ')}${userPermissions?.allowedOutlets?.length > 5 ? '...' : ''}]<br>
                    • Can Add Outlets: ${userPermissions?.canAddOutlets || 'false'}<br>
                    • Role: ${userPermissions?.role || 'Unknown'}
                `;

                // Phoenix Data Info
                const phoenixInfo = document.getElementById('debug-phoenix-data');
                const outletCount = Object.keys(phoenixData?.outlets || {}).length;
                const phoenixOutletsList = Object.keys(phoenixData?.outlets || {}).slice(0, 10);
                
                phoenixInfo.innerHTML = `
                    <strong>Phoenix Data:</strong><br>
                    • Total Outlets in Data: ${outletCount}<br>
                    • Outlets: [${phoenixOutletsList.join(', ')}${outletCount > 10 ? '...' : ''}]<br>
                    • Displayed Phoenix Outlets: ${phoenixOutlets?.length || 0}<br>
                    • All Available Outlets: ${allOutlets?.length || 0}<br><br>
                    
                    <strong>Data Timestamp:</strong><br>
                    • Last Updated: ${phoenixData?.metadata?.lastUpdated || 'Unknown'}<br>
                    • Version: ${phoenixData?.metadata?.version || 'Unknown'}
                `;

                // Storage Info
                const storageInfo = document.getElementById('debug-storage-info');
                const storageStats = simpleCloudStorage ? 'Available' : 'Not Available';
                
                storageInfo.innerHTML = `
                    <strong>Storage:</strong><br>
                    • Cloud Storage: ${storageStats}<br>
                    • LocalStorage phoenixProjectData: ${localStorage.getItem('phoenixProjectData') ? 'Available' : 'Empty'}<br>
                    • LocalStorage Size: ${localStorage.getItem('phoenixProjectData')?.length || 0} chars<br>
                    • SessionStorage userAuth: ${sessionStorage.getItem('userAuth') ? 'Available' : 'Empty'}<br><br>
                    
                    <strong>Filtering Check:</strong><br>
                    ${checkOutletFiltering()}
                `;

                console.log('🔄 Debug info refreshed');
            } catch (error) {
                console.error('❌ Error refreshing debug info:', error);
            }
        }

        function checkOutletFiltering() {
            if (!phoenixData?.outlets || !userPermissions) {
                return '• Cannot check - missing data';
            }

            let filterResults = '';
            Object.keys(phoenixData.outlets).forEach(outletCode => {
                const canView = userPermissions.canViewAllOutlets || userPermissions.allowedOutlets.includes(outletCode);
                filterResults += `• ${outletCode}: ${canView ? '✅ Visible' : '❌ Filtered'}<br>`;
            });

            return filterResults || '• No outlets to check';
        }

        function forceLoadAllOutlets() {
            try {
                console.log('🔓 Force loading all outlets (bypassing permissions)...');
                
                // Temporarily override permissions to load all outlets
                const originalPermissions = { ...userPermissions };
                userPermissions.canViewAllOutlets = true;
                userPermissions.allowedOutlets = allOutlets.map(outlet => outlet.code);
                
                // Reload Phoenix outlets with bypassed permissions
                loadPhoenixOutlets();
                renderPhoenixDashboard();
                
                // Show notification
                showNotification('🔓 Force loaded all outlets (permissions temporarily bypassed)', 'warning');
                
                // Restore original permissions after 5 seconds
                setTimeout(() => {
                    userPermissions = originalPermissions;
                    console.log('🔒 Original permissions restored');
                    refreshDebugInfo();
                }, 5000);
                
            } catch (error) {
                console.error('❌ Error force loading outlets:', error);
                showNotification('❌ Failed to force load outlets', 'error');
            }
        }

        function exportDebugInfo() {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    currentUser: currentUser,
                    userPermissions: userPermissions,
                    phoenixData: phoenixData,
                    phoenixOutlets: phoenixOutlets.map(outlet => ({ code: outlet.code, name: outlet.name })),
                    allOutlets: allOutlets.map(outlet => ({ code: outlet.code, name: outlet.name })),
                    localStorage: {
                        phoenixProjectData: !!localStorage.getItem('phoenixProjectData'),
                        phoenixProjectDataSize: localStorage.getItem('phoenixProjectData')?.length || 0
                    },
                    sessionStorage: {
                        userAuth: !!sessionStorage.getItem('userAuth')
                    }
                };

                const content = JSON.stringify(debugData, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `phoenix-debug-${new Date().toISOString().substring(0, 16).replace(':', '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('📤 Debug info exported successfully', 'success');
            } catch (error) {
                console.error('❌ Error exporting debug info:', error);
                showNotification('❌ Failed to export debug info', 'error');
            }
        }
    </script>
</body>
</html>